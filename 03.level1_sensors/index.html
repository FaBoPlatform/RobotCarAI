



<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="クリップボードへコピー">
      
        <meta name="lang:clipboard.copied" content="コピーしました">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="何も見つかりませんでした">
      
        <meta name="lang:search.result.one" content="1件見つかりました">
      
        <meta name="lang:search.result.other" content="#件見つかりました">
      
        <meta name="lang:search.tokenizer" content="[\s\-　、。，．]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Index - FaBo RobotCarAI Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#1" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="FaBo RobotCarAI Docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              FaBo RobotCarAI Docs
            </span>
            <span class="md-header-nav__topic">
              Index
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="FaBo RobotCarAI Docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    FaBo RobotCarAI Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="RobotCarAI" class="md-nav__link">
      RobotCarAI
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      00.install raspberry pi3
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        00.install raspberry pi3
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../00.install_raspberry_pi3/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      01.fabodrive
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        01.fabodrive
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01.fabodrive/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      02.level1 car
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        02.level1 car
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../02.level1_car/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      03.level1 sensors
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        03.level1 sensors
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Index
      </label>
    
    <a href="./" title="Index" class="md-nav__link md-nav__link--active">
      Index
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目次</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#3" title="3つの距離センサーから値を取得し、ロボットカーが走行可能な進行方向をニューラルネットワークモデルを用いて予測する" class="md-nav__link">
    3つの距離センサーから値を取得し、ロボットカーが走行可能な進行方向をニューラルネットワークモデルを用いて予測する
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" title="インストール方法" class="md-nav__link">
    インストール方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="コースの準備" class="md-nav__link">
    コースの準備
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="実行方法" class="md-nav__link">
    実行方法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-raspberry-pi3" title="1. ロボットカーのRaspberry Pi3にログインします" class="md-nav__link">
    1. ロボットカーのRaspberry Pi3にログインします
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-rootdockerid" title="2. rootになってdockerコンテナIDを調べます" class="md-nav__link">
    2. rootになってdockerコンテナIDを調べます
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-docker" title="3. dockerコンテナにログインします" class="md-nav__link">
    3. dockerコンテナにログインします
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" title="4. ロボットカーのディレクトリに移動します" class="md-nav__link">
    4. ロボットカーのディレクトリに移動します
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" title="5. ニューラルネットワークによる進行方向判断処理を実行します" class="md-nav__link">
    5. ニューラルネットワークによる進行方向判断処理を実行します
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="これ以降について" class="md-nav__link">
    これ以降について
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware-lidarlite-v3" title="[Hardware] 距離センサーLidarLite v3について" class="md-nav__link">
    [Hardware] 距離センサーLidarLite v3について
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" title="取得できる距離、値、誤差、測定周期" class="md-nav__link">
    取得できる距離、値、誤差、測定周期
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neural-networks" title="[Neural Networks] 学習データのフォーマットについて" class="md-nav__link">
    [Neural Networks] 学習データのフォーマットについて
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" title="クラス分類" class="md-nav__link">
    クラス分類
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#one-hot-value" title="one hot value" class="md-nav__link">
    one hot value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="データフォーマット" class="md-nav__link">
    データフォーマット
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python" title="[Python] 学習データ ジェネレータを作る" class="md-nav__link">
    [Python] 学習データ ジェネレータを作る
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#if" title="簡単なIF文での判定" class="md-nav__link">
    簡単なIF文での判定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="車両旋回性能" class="md-nav__link">
    車両旋回性能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="曲がる、止まる判定" class="md-nav__link">
    曲がる、止まる判定
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neural-networks_1" title="[Neural Networks] 学習モデルについて" class="md-nav__link">
    [Neural Networks] 学習モデルについて
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-layer-perceptron" title="Multi-Layer Perceptron" class="md-nav__link">
    Multi-Layer Perceptron
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow" title="[Python/TensorFlow] 学習用コードのコーディング" class="md-nav__link">
    [Python/TensorFlow] 学習用コードのコーディング
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="学習コード設計" class="md-nav__link">
    学習コード設計
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow_1" title="[Python/TensorFlow] 学習と保存" class="md-nav__link">
    [Python/TensorFlow] 学習と保存
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" title="学習実行" class="md-nav__link">
    学習実行
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="保存と読み込み" class="md-nav__link">
    保存と読み込み
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="再利用可能な方法" class="md-nav__link">
    再利用可能な方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint" title="checkpointに保存" class="md-nav__link">
    checkpointに保存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint_1" title="checkpointを読み込む" class="md-nav__link">
    checkpointを読み込む
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="凍結する方法" class="md-nav__link">
    凍結する方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pb" title="pbファイルに保存" class="md-nav__link">
    pbファイルに保存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pb_1" title="pbファイルを読み込む" class="md-nav__link">
    pbファイルを読み込む
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow_2" title="[Python/TensorFlow] 予測を実行" class="md-nav__link">
    [Python/TensorFlow] 予測を実行
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="距離センサーから値を取得して予測を実行する" class="md-nav__link">
    距離センサーから値を取得して予測を実行する
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow_3" title="[Python/TensorFlow] 予測精度を評価" class="md-nav__link">
    [Python/TensorFlow] 予測精度を評価
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" title="ディレクトリとファイルについて" class="md-nav__link">
    ディレクトリとファイルについて
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      04.level1 demo
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        04.level1 demo
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../04.level1_demo/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      05.level2 lane detection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        05.level2 lane detection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../05.level2_lane_detection/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      06.level2 demo
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        06.level2 demo
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../06.level2_demo/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      07.level2 demo socket
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        07.level2 demo socket
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../07.level2_demo_socket/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      08.level3 object detection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        08.level3 object detection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../08.level3_object_detection/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      09.level3 demo socket
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        09.level3 demo socket
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../09.level3_demo_socket/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      10.level3 demo streaming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        10.level3 demo streaming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../10.level3_demo_streaming/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      11.level4 lane detection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        11.level4 lane detection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../11.level4_lane_detection/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      12.level5 demo streaming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        12.level5 demo streaming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../12.level5_demo_streaming/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目次</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#3" title="3つの距離センサーから値を取得し、ロボットカーが走行可能な進行方向をニューラルネットワークモデルを用いて予測する" class="md-nav__link">
    3つの距離センサーから値を取得し、ロボットカーが走行可能な進行方向をニューラルネットワークモデルを用いて予測する
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" title="インストール方法" class="md-nav__link">
    インストール方法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="コースの準備" class="md-nav__link">
    コースの準備
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="実行方法" class="md-nav__link">
    実行方法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-raspberry-pi3" title="1. ロボットカーのRaspberry Pi3にログインします" class="md-nav__link">
    1. ロボットカーのRaspberry Pi3にログインします
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-rootdockerid" title="2. rootになってdockerコンテナIDを調べます" class="md-nav__link">
    2. rootになってdockerコンテナIDを調べます
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-docker" title="3. dockerコンテナにログインします" class="md-nav__link">
    3. dockerコンテナにログインします
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" title="4. ロボットカーのディレクトリに移動します" class="md-nav__link">
    4. ロボットカーのディレクトリに移動します
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" title="5. ニューラルネットワークによる進行方向判断処理を実行します" class="md-nav__link">
    5. ニューラルネットワークによる進行方向判断処理を実行します
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="これ以降について" class="md-nav__link">
    これ以降について
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware-lidarlite-v3" title="[Hardware] 距離センサーLidarLite v3について" class="md-nav__link">
    [Hardware] 距離センサーLidarLite v3について
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" title="取得できる距離、値、誤差、測定周期" class="md-nav__link">
    取得できる距離、値、誤差、測定周期
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neural-networks" title="[Neural Networks] 学習データのフォーマットについて" class="md-nav__link">
    [Neural Networks] 学習データのフォーマットについて
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" title="クラス分類" class="md-nav__link">
    クラス分類
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#one-hot-value" title="one hot value" class="md-nav__link">
    one hot value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="データフォーマット" class="md-nav__link">
    データフォーマット
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python" title="[Python] 学習データ ジェネレータを作る" class="md-nav__link">
    [Python] 学習データ ジェネレータを作る
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#if" title="簡単なIF文での判定" class="md-nav__link">
    簡単なIF文での判定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="車両旋回性能" class="md-nav__link">
    車両旋回性能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="曲がる、止まる判定" class="md-nav__link">
    曲がる、止まる判定
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#neural-networks_1" title="[Neural Networks] 学習モデルについて" class="md-nav__link">
    [Neural Networks] 学習モデルについて
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-layer-perceptron" title="Multi-Layer Perceptron" class="md-nav__link">
    Multi-Layer Perceptron
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow" title="[Python/TensorFlow] 学習用コードのコーディング" class="md-nav__link">
    [Python/TensorFlow] 学習用コードのコーディング
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" title="学習コード設計" class="md-nav__link">
    学習コード設計
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow_1" title="[Python/TensorFlow] 学習と保存" class="md-nav__link">
    [Python/TensorFlow] 学習と保存
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" title="学習実行" class="md-nav__link">
    学習実行
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" title="保存と読み込み" class="md-nav__link">
    保存と読み込み
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" title="再利用可能な方法" class="md-nav__link">
    再利用可能な方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint" title="checkpointに保存" class="md-nav__link">
    checkpointに保存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint_1" title="checkpointを読み込む" class="md-nav__link">
    checkpointを読み込む
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" title="凍結する方法" class="md-nav__link">
    凍結する方法
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pb" title="pbファイルに保存" class="md-nav__link">
    pbファイルに保存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pb_1" title="pbファイルを読み込む" class="md-nav__link">
    pbファイルを読み込む
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow_2" title="[Python/TensorFlow] 予測を実行" class="md-nav__link">
    [Python/TensorFlow] 予測を実行
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" title="距離センサーから値を取得して予測を実行する" class="md-nav__link">
    距離センサーから値を取得して予測を実行する
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythontensorflow_3" title="[Python/TensorFlow] 予測精度を評価" class="md-nav__link">
    [Python/TensorFlow] 予測精度を評価
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" title="ディレクトリとファイルについて" class="md-nav__link">
    ディレクトリとファイルについて
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <p><a name='top'></p>
<p>【タイトル】</p>
<h1 id="1">レベル1：距離センサーの値をニューラルネットワークで使う</h1>
<hr>

<p>【目標】</p>
<h4 id="3">3つの距離センサーから値を取得し、ロボットカーが走行可能な進行方向をニューラルネットワークモデルを用いて予測する</h4>
<p>【画像】<br>
<img alt="" src="document/robotcar.jpg" /><br></p>
<p>【実行環境】<br>
* Fabo TYPE1 ロボットカー<br>
  * Fabo #902 Kerberos ver 1.0.0<br>
  * VL53L0X or Lidar Lite v3<br>
  * Raspberry Pi3<br>
    * Stretch Lite or Jessie Lite<br>
    * docker<br>
      * Ubuntu<br>
      * Python 2.7<br>
      * Tensorflow r1.1.0<br></p>
<hr>

<p><a name='0'></p>
<p>【実行】<br>
* <a href="#a">インストール方法</a><br>
* <a href="#course">コースの準備</a><br>
* <a href="#b">実行方法</a><br></p>
<p>【目次】<br>
* [Hardware] <a href="#1">距離センサーLidarLite v3について</a><br>
  * 取得できる距離、値、誤差、測定周期<br>
* [Neural Networks] <a href="#2">学習データのフォーマットについて</a><br>
  * クラス分類<br>
  * one hot value<br>
  * データフォーマット<br>
* [Python] <a href="#3">学習データ ジェネレータを作る</a><br>
  * 簡単なIF文での判定<br>
  * 車両旋回性能<br>
  * 曲がる、止まる判定<br>
* [Neural Networks] <a href="#4">学習モデルについて</a><br>
  * Multi-Layer Perceptron<br>
* [Python/TensorFlow] <a href="#5">学習用コードのコーディング</a><br>
  * 学習コード設計<br>
* [Python/TensorFlow] <a href="#6">学習と保存</a><br>
  * 学習実行<br>
  * 保存と読み込み<br>
* [Python/TensorFlow] <a href="#7">予測を実行</a><br>
* [Python/TensorFlow] <a href="#8">予測精度を評価</a><br>
* <a href="#9">ディレクトリとファイルについて</a><br>
<hr></p>
<p><a name='a'></p>
<h2 id="_1">インストール方法</h2>
<p>インストール済みのロボットカーを用意しているので省略します。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='course'></p>
<h2 id="_2">コースの準備</h2>
<p>ここはニューラルネットワークの学習と実行の項目なので、ロボットカーは走行しないのでコースの準備は不要です。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='b'></p>
<h2 id="_3">実行方法</h2>
<h4 id="1-raspberry-pi3">1. ロボットカーのRaspberry Pi3にログインします</h4>
<p>USER:pi<br>
PASSWORD:raspberry<br></p>
<blockquote>
<p><code>ssh pi@192.168.xxx.xxx</code><br></p>
</blockquote>
<h4 id="2-rootdockerid">2. rootになってdockerコンテナIDを調べます</h4>
<blockquote>
<p><code>sudo su</code><br>
<code>docker ps -a</code><br></p>
<blockquote>
<p>CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS                     PORTS                                                                    NAMES<br>
2133fa3ca362        naisy/fabo-jupyter-armhf   "/bin/bash -c 'jup..."   3 weeks ago         Up 2 minutes               0.0.0.0:6006-&gt;6006/tcp, 0.0.0.0:8091-&gt;8091/tcp, 0.0.0.0:8888-&gt;8888/tcp   hardcore_torvalds<br></p>
</blockquote>
</blockquote>
<p>STATUSがUpになっているコンテナIDをメモします。</p>
<h4 id="3-docker">3. dockerコンテナにログインします</h4>
<p>docker exec -it CONTAINER_ID /bin/bash<br></p>
<blockquote>
<p><code>docker exec -it 2133fa3ca362 /bin/bash</code><br></p>
</blockquote>
<p>CONTAINER_IDにはベースイメージがnaisy/fabo-jupyter-armhfの2133fa3ca362を使います。<br></p>
<h4 id="4">4. ロボットカーのディレクトリに移動します</h4>
<blockquote>
<p><code>cd /notebooks/github/RobotCarAI/level1_sensors/</code><br>
<code>ls</code><br></p>
<blockquote>
<p>total 104<br>
160616  4 ./    125780 48 README.md  160618  4 generator/  142810  4 run_ai.py           141770  4 to_one_hot_value.py<br>
 123628  4 ../   160709  4 document/  160686  4 lib/        125870  8 run_ai_eval.py<br>
160617  4 MLP/  160710  4 fabolib/   160687  4 model/      125871  8 run_ai_eval_400.py<br></p>
</blockquote>
</blockquote>
<h4 id="5">5. ニューラルネットワークによる進行方向判断処理を実行します</h4>
<p>今回は学習済みのモデルを実行します。</p>
<blockquote>
<p><code>python run_ai.py</code><br></p>
<blockquote>
<p>[DEBUG] time:1518164009.79348111 pid:170 pn:MainProcess tid:1811108976 tn:Thread-1   fn:do_stop    enter<br>
learned_step:50000000<br>
result:FORWARD [218, 511, 112]        <br>
main end<br></p>
</blockquote>
</blockquote>
<h4 id="_4">これ以降について</h4>
<p>学習にはメモリやCPU性能のいいマシンを用意する必要があります。<br>
この学習はAWS c5.xlargeインスタンスで一週間程度実行してあります。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='1'></p>
<h2 id="hardware-lidarlite-v3">[Hardware] 距離センサーLidarLite v3について</h2>
<p>CLASS1 LASERで距離を計測する機器。</p>
<h4 id="_5">取得できる距離、値、誤差、測定周期</h4>
<ul>
<li>測定可能距離は40m<br></li>
<li>cm単位の整数値で取得<br></li>
<li>測定誤差は5m以内で2.5cm、5m以上で10cm<Br></li>
<li>測定周期は50Hz=0.02秒間隔<br></li>
</ul>
<p>仕様書：<a href="https://static.garmin.com/pumac/LIDAR_Lite_v3_Operation_Manual_and_Technical_Specifications.pdf">https://static.garmin.com/pumac/LIDAR_Lite_v3_Operation_Manual_and_Technical_Specifications.pdf</a></p>
<p>ここはlevel1_carと同じ内容になります。</p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='2'></p>
<h2 id="neural-networks">[Neural Networks] 学習データのフォーマットについて</h2>
<h4 id="_6">クラス分類</h4>
<p>ロボットカーの進行方向の予測は、STOP,LEFT,FOWARD,RIGHTのどれか一つに属します。これを一般的にクラス分類と呼びます。<br>
画像認識では、用意したクラスのどれにも属さないことを表すためにその他クラスも用意しますが、今回のセンサー値を入力値としたロボットカーの進行方向予測では、その他は存在しないものと考えます。
<hr></p>
<h4 id="one-hot-value">one hot value</h4>
<p>Neural Networksでは予測結果を確率で算出するため、全てのクラスの確率の和を1にします。<br>
クラス分類では、入力値はどれか一つのクラスに属するため、そのクラスだけを1に、他のクラスを0にした正解ラベルを用意します。これを一般的にone hot valueと呼びます。</p>
<table>
<thead>
<tr>
<th>クラス分類</th>
<th>STOP</th>
<th>LEFT</th>
<th>FOWARD</th>
<th>RIGHT</th>
</tr>
</thead>
<tbody>
<tr>
<td>label0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>label1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>label2</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>label3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>pythonでは、numpyを使ってone hot valueを作ることが出来ます。<br>
ソースコード：<a href="to_one_hot_value.py">./to_one_hot_value.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># coding: utf-8</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=kn>as</span> <span class=nn>np</span>
<span class=n>n_classes</span> <span class=o>=</span> <span class=mi>4</span> <span class=c1># クラス分類の総数</span>
<span class=c1>########################################</span>
<span class=c1># ラベル番号をone_hot_valueに変換する</span>
<span class=c1>########################################</span>
<span class=k>def</span> <span class=nf>to_one_hot_value</span><span class=p>(</span><span class=n>int_label</span><span class=p>):</span>
    <span class=n>one_hot_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span><span class=n>n_classes</span><span class=p>))</span>
    <span class=n>one_hot_value</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>int_label</span><span class=p>])]</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=k>return</span> <span class=n>one_hot_value</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_classes</span><span class=p>):</span>
    <span class=n>one_hot_value</span> <span class=o>=</span> <span class=n>to_one_hot_value</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;label:{} one_hot_value:{}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>one_hot_value</span><span class=p>))</span>
</pre></div></td></tr></table></p>
<blockquote>
<p>label:0 one_hot_value:[[ 1.  0.  0.  0.]]<br>
label:1 one_hot_value:[[ 0.  1.  0.  0.]]<br>
label:2 one_hot_value:[[ 0.  0.  1.  0.]]<br>
label:3 one_hot_value:[[ 0.  0.  0.  1.]]<br></p>
</blockquote>
<p>今回は学習データ ジェネレータの分岐バグチェックを兼ねてone hot valueを作るのでこのコードは出てきませんが、画像認識などでデータがすでにあり、ラベル付けを別途行わなければならない場合に使います。
<hr></p>
<h4 id="_7">データフォーマット</h4>
<p>距離センサーを3個使うので入力値は3つ、出力値はone hot valueで表すので4つとなり、学習データのフォーマットはCSVで表すと以下のようになります。<br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>#left_sensor,front_sensor,right_sensor,stop,left,foward,right
0,0,0,1,0,0,0
200,200,50,0,1,0,0
200,200,200,0,0,1,0
50,200,200,0,0,0,1
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='3'></p>
<h2 id="python">[Python] 学習データ ジェネレータを作る</h2>
<p>学習データフォーマットが決まったので、実際に学習データを作っていきます。<br>
CSVデータを人力で用意していってもよいのですが、IF文で書ける分岐条件なので関数で書いてしまうことにします。<br>
<hr></p>
<p><a name='3-1'></p>
<h4 id="if">簡単なIF文での判定</h4>
<p>level_carで作ったSimpleLabelGenerator。</p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># coding: utf-8</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=kn>as</span> <span class=nn>np</span>
<span class=k>class</span> <span class=nc>SimpleLabelGenerator</span><span class=p>():</span>
    <span class=k>def</span> <span class=nf>get_label</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>sensors</span><span class=p>):</span>
        <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>        sensors: [左センサー値,前センサー値,右センサー値]</span>
<span class=sd>        &#39;&#39;&#39;</span>

        <span class=k>if</span> <span class=n>sensors</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span> <span class=c1># 前方に空きが無い</span>
            <span class=k>return</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> <span class=c1># STOP</span>
        <span class=k>elif</span> <span class=n>sensors</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span> <span class=c1># 左に空きが無い</span>
            <span class=k>return</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span> <span class=c1># RIGHT</span>
        <span class=k>elif</span> <span class=n>sensors</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>20</span><span class=p>:</span> <span class=c1># 右に空きが無い</span>
            <span class=k>return</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> <span class=c1># LEFT</span>
        <span class=k>else</span><span class=p>:</span> <span class=c1># 全方向に空きがある</span>
            <span class=k>return</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> <span class=c1># FOWARD</span>

<span class=n>generator</span> <span class=o>=</span> <span class=n>SimpleLabelGenerator</span><span class=p>()</span>
<span class=n>n_rows</span> <span class=o>=</span> <span class=mi>10</span> <span class=c1># 作成するデータ件数</span>
<span class=n>sensors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>200</span><span class=p>,[</span><span class=n>n_rows</span><span class=p>,</span><span class=mi>3</span><span class=p>])</span> <span class=c1># 範囲0-200の値で3つの値を持つ配列をn_rows個作る</span>
<span class=k>print</span><span class=p>(</span><span class=s2>&quot;--- sensors ---</span><span class=se>\n</span><span class=s2>{}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>sensors</span><span class=p>))</span>
<span class=n>csvdata</span><span class=o>=</span><span class=p>[]</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_rows</span><span class=p>):</span>
    <span class=n>generator_result</span> <span class=o>=</span> <span class=n>generator</span><span class=o>.</span><span class=n>get_label</span><span class=p>(</span><span class=n>sensors</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
    <span class=n>csvrow</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>hstack</span><span class=p>((</span><span class=n>sensors</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>generator_result</span><span class=p>))</span>
    <span class=n>csvdata</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>csvrow</span><span class=p>)</span>
<span class=n>csvdata</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>csvdata</span><span class=p>)</span>
<span class=k>print</span><span class=p>(</span><span class=s2>&quot;--- batch data ---</span><span class=se>\n</span><span class=s2>{}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>csvdata</span><span class=p>))</span>
</pre></div></td></tr></table></p>
<blockquote>
<p>--- sensors ---<br>
[[123  76 172]<br>
 [ 12  74  98]<br>
 [ 52  59  45]<br>
 [ 51 137 147]<br>
 [  8  45  58]<br>
 [ 87 176 189]<br>
 [183  34 197]<br>
 [115   4 100]<br>
 [108 154 136]<br>
 [140  53 101]]<br>
--- batch data ---<br>
[[123  76 172   0   0   1   0]<br>
 [ 12  74  98   1   0   0   0]<br>
 [ 52  59  45   0   1   0   0]<br>
 [ 51 137 147   0   0   1   0]<br>
 [  8  45  58   1   0   0   0]<br>
 [ 87 176 189   0   0   1   0]<br>
 [183  34 197   0   0   0   1]<br>
 [115   4 100   0   0   0   1]<br>
 [108 154 136   0   0   1   0]<br>
 [140  53 101   0   0   1   0]]<br></p>
</blockquote>
<hr>

<h4 id="_8">車両旋回性能</h4>
<p><a href="#3-1">簡単なIF文での判定</a>のラベルジェネレータはlevel1_carで実際に使っていますが、車両の旋回性能に合わせたカスタマイズがあってもよいかもしれません。そこで、車両がどのように旋回するのかを考慮してみます。<br>
(実際のところ、定常円を描けなかったり左右で旋回半径が異なったりする車両の足回りでは計算通りの旋回にならないので走行具合をみて調整が必要になります。)<br>
<hr></p>
<p>車両の旋回は、リアタイヤの車軸の延長線上に円の中心が来ることから、旋回イメージを図に描いてみます。
<img alt="" src="document/magaru1.png" />
図に描いてみると、避けきれない前方障害物(点P)の存在も見えてきます。
<hr></p>
<p>車両データを実測します。<br>
赤い#1202,#605,#103,#902はFabo製プロトタイピング用基板。
<img alt="" src="document/robotcar.png" />
ホイールベースとノーズは個別に使うことはしていないので、単純に全長と考えてよいです。
<hr></p>
<p>車両データを旋回イメージに当てはめます。
<img alt="" src="document/magaru2.png" />
<hr></p>
<h4 id="_9">曲がる、止まる判定</h4>
<p>車両の旋回イメージが出来たので、旋回に入る距離と、旋回しても回避出来ないため停止と判断する距離を算出します。
<img alt="" src="document/calc1.png" />
止まる為に用意した10cmマージンは、車両制御コード側で前方障害物までの距離を元に速度調整を入れたため、実際の学習データ ジェネレータのコードでは10cmマージンを削除してあります。
<hr></p>
<p>旋回方向は左右のより空いている方向に曲がればよいのですが、左右どちらにも壁があり曲がれないことも考慮します。
<img alt="" src="document/habadori.png" />
分岐パターンを適当に決めます。3つの距離センサー値はそれぞれ以下の3パターンで考えることが出来ます。
* パターン0： 障害物までの距離が遠いため、制御不要
* パターン1： 障害物までの距離が近いため、制御必要
* パターン2： 障害物までの距離が近すぎるため、その方向には進めない</p>
<p>左前右センサー値をそれぞれこのパターンのどれにあたるのかをIF文で判断し、次に進行方向を決定するための分岐を作成します。
* コントロール1：前2 - 直進も旋回も出来ないため停止する
* コントロール分岐：左01,前1,右01 - 前方障害物あり。左右旋回可能。左右の距離が遠い方に曲がる
  * コントロール2：右の方が距離が遠い場合。右に曲がる
  * コントロール3：左の方が距離が遠い場合。左に曲がる
* コントロール4：右0前0左0 - 制御不要のため、直進する
* コントロール5：左12右0 - 左は障害物までの距離が近いか近すぎるため、右に曲がる
* コントロール6：左0右12 - 右は障害物までの距離が近いか近すぎるため、左に曲がる
* コントロール7：左2右2 - 左も右も旋回不可能。前方はコントロール1を通過しているので進行可能。直進するが、もしかしたら壁にぶつかる可能性もある
* コントロール分岐：左1右1 - 左右どちらも障害物に近いので、真ん中になるように幅調整をする
  * コントロール8：右の方が距離が遠い場合。右に曲がる
  * コントロール9：左の方が距離が遠い場合。左に曲がる
* コントロール10：左2右1 - 左は障害物までの距離が近すぎるため、右に曲がる
* コントロール11：左1右2 - 右は障害物までの距離が近すぎるため、左に曲がる</p>
<p>制御分岐を通ったら<a href="#3-1">簡単なIF文での判定</a>と同様にone hot valueで値を返して学習データ ジェネレータは完成です。<br></p>
<p>ラベル ジェネレータ：<a href="generator/labelgenerator.py">./generator/labelgenerator.py</a><br>
学習データ ジェネレータ：<a href="MLP/train_model.py">./MLP/train_model.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>generate_random_train_data</span><span class=p>(</span><span class=n>n_rows</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    ランダムなセンサー値と、それに対応するラベルデータを作成する</span>
<span class=sd>    args:</span>
<span class=sd>        n_rows: 作成するデータ件数</span>
<span class=sd>    return:</span>
<span class=sd>        batch_data: センサー値</span>
<span class=sd>        batch_target: ラベルデータ</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>csvdata</span><span class=o>=</span><span class=p>[]</span>
    <span class=c1># 2m以内のランダムなINT値を作成する</span>
    <span class=n>sensors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>200</span><span class=p>,[</span><span class=n>n_rows</span><span class=p>,</span><span class=n>DATA_COLS</span><span class=p>])</span>

    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_rows</span><span class=p>):</span>
        <span class=n>generator_result</span> <span class=o>=</span> <span class=n>generator</span><span class=o>.</span><span class=n>get_label</span><span class=p>(</span><span class=n>sensors</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
        <span class=n>csvrow</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>hstack</span><span class=p>((</span><span class=n>sensors</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>generator_result</span><span class=p>))</span>
        <span class=n>csvdata</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>csvrow</span><span class=p>)</span>
    <span class=n>csvdata</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>csvdata</span><span class=p>)</span>

    <span class=n>batch_data</span> <span class=o>=</span> <span class=n>csvdata</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>n_rows</span><span class=p>,</span><span class=mi>0</span><span class=p>:</span><span class=n>DATA_COLS</span><span class=p>]</span>
    <span class=n>batch_target</span> <span class=o>=</span> <span class=n>csvdata</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>n_rows</span><span class=p>,</span><span class=n>DATA_COLS</span><span class=p>:]</span>
    <span class=k>return</span> <span class=n>batch_data</span><span class=p>,</span> <span class=n>batch_target</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='4'></p>
<h2 id="neural-networks_1">[Neural Networks] 学習モデルについて</h2>
<p>学習モデルはシンプルなMulti-Layer Perceptronで作成します。</p>
<h4 id="multi-layer-perceptron">Multi-Layer Perceptron</h4>
<p><img alt="" src="document/mlp.png" />
入力層はセンサー値を入れるため3入力を持ちます。<br>
隠れ層は1つだけ持ち、11ノードを用意します。各ノードは3つのセンサー値を入力に持ちます。<br>
隠れ層と出力層では全ての入力線で個別にweightを持ち、各ノード毎にbiasを持ちます。<br>
Neural Networksではこのweightとbiasの値が学習成果となり、ノードの形をモデルと呼びます。値とモデル構造が分かれていることは主に学習途中からの再開時(checkpointからの値のrestore)や、学習成果を凍結する時(ノード情報と値をpbファイルに保存。freeze graph)に現れます。</p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='5'></p>
<h2 id="pythontensorflow">[Python/TensorFlow] 学習用コードのコーディング</h2>
<h4 id="_10">学習コード設計</h4>
<ul>
<li>簡単かつスケール増減が単純なMulti-Layer Perceptronモデルとする<br></li>
<li>学習データ ジェネレータを作成する<br></li>
<li>実装はミニバッチでおこなう<br></li>
<li>学習データ処理にはスレッドセーフなデータスタックが可能なqueueを用いる<br></li>
<li>予測時に用いる入出力オペレーションには名前を付ける<br></li>
<li>ステップ数を記録する<br></li>
<li>checkpoint保存と途中から再開する<br></li>
<li>Tensorboard用にsummary出力する<br></li>
<li>定数の変数は大文字にする<br></li>
</ul>
<p>ミニバッチとは、学習時に特徴量を算出しやくするために、学習データを10～100個程度に小分けにしたものになります。<br>
1つのミニバッチデータには各クラスが同数含まれている方が精度が良くなりますが、今回は気にしないことにします。<br>
1ステップ毎の学習中に次のステップで使う学習データを準備するために、ミニバッチのデータ作成はスレッドで実行してqueueに入れます。<br>
。<br></p>
<hr>

<p><img alt="" src="document/code-design1.png" />
<img alt="" src="document/code-design2.png" />
<img alt="" src="document/code-design3.png" />
<img alt="" src="document/code-design4.png" />
<img alt="" src="document/code-design5.png" />
<hr></p>
<p>センサー値の入力変数はplaceholder_input_dataとdequeue_input_dataの2種類あります。<br>
予測実行時のセンサー値の入力変数はdequeue_input_dataとなるオペレーション名dequeue_op:0を使います。<br>
学習コード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=n>dequeue_input_data</span><span class=p>,</span> <span class=n>dequeue_input_target</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>dequeue_many</span><span class=p>(</span><span class=n>placeholder_batch_size</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dequeue_op&#39;</span><span class=p>)</span> <span class=c1># instead of data/target placeholder</span>
</pre></div></td></tr></table></p>
<hr>

<p>ミニバッチサイズを可変とするためにplaceholderを使い、行数をNoneとしています。<br>
学習コード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>placeholder_input_data</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>placeholder</span><span class=p>(</span><span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=p>[</span><span class=bp>None</span><span class=p>,</span> <span class=n>DATA_COLS</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;input_data&#39;</span><span class=p>)</span> <span class=c1># for load_and_enqueue. use dequeue_op:0 for prediction</span>
</pre></div></td></tr></table></p>
<hr>

<p>placeholderの行数をNoneとすることで、1つの値を予測するためであっても予測にかけるデータは配列に入れる必要が生じますが([[左センサー値,前センサー値,右センサー値]])、学習時のミニバッチサイズと予測時のデータ件数は異なるため、入力変数に使うplaceholderの行数はNoneとすることで、モデルで可変行数の入力値を扱えるようにします。<br>
予測実行コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># センサー値をランダムな0-1000の範囲で作成する</span>
        <span class=c1># sensors = [[LEFT45,FRONT,RIGHT45]]</span>
        <span class=n>sensors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1000</span><span class=p>,</span><span class=mi>3</span><span class=p>)])</span>

        <span class=c1># 予測を実行する</span>
        <span class=n>_output_y</span><span class=p>,</span><span class=n>_score</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=n>output_y</span><span class=p>,</span><span class=n>score</span><span class=p>],</span><span class=n>feed_dict</span><span class=o>=</span><span class=p>{</span><span class=n>input_x</span><span class=p>:</span><span class=n>sensors</span><span class=p>})</span>
</pre></div></td></tr></table></p>
<hr>

<p>ミニバッチデータは学習とは別のスレッドで作成するので、スレッドセーフなqueueに入れておきます。<br>
queueには1ステップ分の学習データを入れておくので、queueの容量をBATCH_SIZEにしてあります。<br>
TensorFlowでは、オペレーションの実行はsess.run()で指定したオペレーションと関連しているオペレーションが連鎖的に実行されるため、ここはqueueの出し入れについてのオペレーション定義をしている部分となります。<br>
ソースコード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>CHUNK_SIZE</span> <span class=o>=</span> <span class=n>BATCH_SIZE</span><span class=o>*</span><span class=mi>1</span> <span class=c1># queueで保持するデータ件数</span>
<span class=o>...</span>
<span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>variable_scope</span><span class=p>(</span><span class=s2>&quot;queue&quot;</span><span class=p>):</span>
    <span class=n>queue</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>FIFOQueue</span><span class=p>(</span>
        <span class=n>capacity</span><span class=o>=</span><span class=n>CHUNK_SIZE</span><span class=p>,</span> <span class=c1># enqueue size</span>
        <span class=n>dtypes</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;float&#39;</span><span class=p>,</span> <span class=s1>&#39;float&#39;</span><span class=p>],</span>
        <span class=n>shapes</span><span class=o>=</span><span class=p>[[</span><span class=n>DATA_COLS</span><span class=p>],</span> <span class=p>[</span><span class=n>N_CLASSES</span><span class=p>]],</span>
        <span class=n>name</span><span class=o>=</span><span class=s1>&#39;FIFOQueue&#39;</span>
    <span class=p>)</span>

    <span class=c1># Enqueue and dequeue operations</span>
    <span class=n>enqueue_op</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>enqueue_many</span><span class=p>([</span><span class=n>placeholder_input_data</span><span class=p>,</span> <span class=n>placeholder_input_target</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;enqueue_op&#39;</span><span class=p>)</span>
    <span class=c1># dequeue_manyでBATCH_SIZE分のデータを取得する。テストデータや実際に予測時に使う可変個数のデータ件数に対応するためにplaceholderで取得件数を指定する。</span>
    <span class=n>dequeue_input_data</span><span class=p>,</span> <span class=n>dequeue_input_target</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>dequeue_many</span><span class=p>(</span><span class=n>placeholder_batch_size</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dequeue_op&#39;</span><span class=p>)</span> <span class=c1># instead of data/target placeholder</span>
</pre></div></td></tr></table></p>
<p>load_and_enqueue()が学習データをqueueに入れる役割になります。これはスレッドで動作させています。<br>
無限ループにあるsess.run()でenqueue_opを実行していますが、queueには指定した容量分しか入らないので、dequeue_many()によってqueueが空になるまで待機することになります。<br>
ソースコード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>N_THREADS</span> <span class=o>=</span> <span class=mi>1</span> <span class=c1># データ生成スレッド件数。ミニバッチデータ作成時間より学習時間の方が処理負荷が高いので、データ生成スレッドは1スレッドにする</span>
<span class=o>...</span>
<span class=k>def</span> <span class=nf>load_and_enqueue</span><span class=p>(</span><span class=n>sess</span><span class=p>):</span>
    <span class=k>while</span> <span class=bp>True</span><span class=p>:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>batch_data</span><span class=p>,</span> <span class=n>batch_target</span> <span class=o>=</span> <span class=n>generate_random_train_data</span><span class=p>(</span><span class=n>BATCH_SIZE</span><span class=p>)</span>
            <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>enqueue_op</span><span class=p>,</span> <span class=n>feed_dict</span><span class=o>=</span><span class=p>{</span><span class=n>placeholder_input_data</span><span class=p>:</span><span class=n>batch_data</span><span class=p>,</span> <span class=n>placeholder_input_target</span><span class=p>:</span><span class=n>batch_target</span><span class=p>})</span>
            <span class=c1>#logging.debug(&quot;running&quot;)</span>
        <span class=k>except</span> <span class=n>tf</span><span class=o>.</span><span class=n>errors</span><span class=o>.</span><span class=n>CancelledError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=k>break</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;finished enqueueing&quot;</span><span class=p>)</span>
<span class=o>...</span>
    <span class=c1># 学習データ ジェネレータを用いてミニバッチデータを作成し、enqueue_op実行によりqueueへデータを挿入するスレッドを開始する</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_THREADS</span><span class=p>):</span>
        <span class=n>enqueue_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>load_and_enqueue</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=n>sess</span><span class=p>])</span>
        <span class=n>enqueue_thread</span><span class=o>.</span><span class=n>isDaemon</span><span class=p>()</span>
        <span class=n>enqueue_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</pre></div></td></tr></table></p>
<p>queueからミニバッチデータを取得するのは、dequeue_opと名付けたオペレーションがsess.run()によって実行された時になります。<br>
これはtrain_opが実行された時に、連鎖的に実行されるオペレーションになります。<br>
実際にコードを追ってみましょう。<br>
ソースコード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=c1># 中間層計算</span>
    <span class=n>layer_1</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>dequeue_input_data</span><span class=p>,</span><span class=n>hidden_layer_1</span><span class=p>[</span><span class=s1>&#39;weights&#39;</span><span class=p>]),</span> <span class=n>hidden_layer_1</span><span class=p>[</span><span class=s1>&#39;biases&#39;</span><span class=p>])</span>
    <span class=n>layer_1</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=n>layer_1</span><span class=p>)</span>
<span class=o>...</span>
    <span class=n>prediction</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>layer_1</span><span class=p>,</span><span class=n>output_layer</span><span class=p>[</span><span class=s1>&#39;weights&#39;</span><span class=p>]),</span> <span class=n>output_layer</span><span class=p>[</span><span class=s1>&#39;biases&#39;</span><span class=p>],</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;output_y&#39;</span><span class=p>)</span>
<span class=o>...</span>
    <span class=n>losses</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>softmax_cross_entropy_with_logits</span><span class=p>(</span><span class=n>logits</span><span class=o>=</span><span class=n>prediction</span><span class=p>,</span> <span class=n>labels</span><span class=o>=</span><span class=n>dequeue_input_target</span><span class=p>)</span>
    <span class=n>loss_op</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>reduce_mean</span><span class=p>(</span><span class=n>losses</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;cost&#39;</span><span class=p>)</span>
<span class=o>...</span>
<span class=n>train_op</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>AdamOptimizer</span><span class=p>(</span><span class=mf>0.0001</span><span class=p>)</span><span class=o>.</span><span class=n>minimize</span><span class=p>(</span><span class=n>loss_op</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;train_op&#39;</span><span class=p>)</span>
<span class=o>...</span>
            <span class=n>_</span><span class=p>,</span> <span class=n>batch_loss</span><span class=p>,</span> <span class=n>w_summary</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=n>train_op</span><span class=p>,</span> <span class=n>loss_op</span><span class=p>,</span> <span class=n>summary_op</span><span class=p>],</span>
                                                <span class=n>feed_dict</span><span class=o>=</span><span class=p>{</span><span class=n>placeholder_batch_size</span><span class=p>:</span><span class=n>BATCH_SIZE</span><span class=p>})</span>
</pre></div></td></tr></table></p>
<p>train_opがsess.run()で実行されると、loss_op-&gt;losses-&gt;prediction-&gt;layer_1-&gt;dequeue_input_dataまで連鎖的に実行されることになります。<br>
この時、dequeue_many()が実行され、queueにある学習データが取得されます。<br>
このコードでは、accuracyとtrain_opをsess.run()で実行した時に、queueからのデータ取得が実行されます。<br>
また、queueからデータ取得が実行された瞬間に、新たにqueueにデータが挿入されることになります。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='6'></p>
<h2 id="pythontensorflow_1">[Python/TensorFlow] 学習と保存</h2>
<h4 id="_11">学習実行</h4>
<blockquote>
<p><code>cd ./MLP/</code><br>
<code>python train_model.py</code><br></p>
</blockquote>
<p>学習はTARGET_STEPまで学習を行います。<br>
学習コード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>TARGET_STEP</span> <span class=o>=</span> <span class=mi>10000</span> <span class=c1># ステップ数</span>
</pre></div></td></tr></table></p>
<p>今回はステップ数もモデルに変数として保存しているので、(途中から再開しても)TARGET_STEPまで学習したらそこで終了します。<br>
TARGET_STEPを増やすことで、さらに学習させることが出来ます。
<hr></p>
<h4 id="_12">保存と読み込み</h4>
<p>保存と読み込みには2種類の方法があります。<br>
* 再学習可能な方法<br>
  * checkpointに保存<br>
  * checkpointを読み込む<br>
* 凍結する方法<br>
  * pbファイルに保存<br>
  * pbファイルを読み込む<br></p>
<p>checkpointに保存すると、学習・実行に必要な全てのモデル構成と変数値が保存されます。そのため、checkpointを読み込むことで学習を再開することが出来ます。<br>
checkpointでは、モデル構成と学習した変数値はそれぞれ別のファイルに保存されるため、読み込みはモデルの読み込み方と、学習値の復元の2種類あります。<br></p>
<p>pbファイルで保存すると、予測に必要なオペレーション名だけを指定してモデル構成と変数値を保存することが出来ます。そのため、再学習に用いることは出来ませんが、バイナリサイズは小さくなります。<br>
pbファイルでは変数値を定数に変換しモデル構成の中に埋め込みます。</p>
<p>step数を記録するために用意したstep変数に関連する情報：pbファイル変換前</p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span>step/input_step [&lt;tf.Tensor &#39;step/input_step:0&#39; shape=&lt;unknown&gt; dtype=int32&gt;]
step/step/initial_value [&lt;tf.Tensor &#39;step/step/initial_value:0&#39; shape=() dtype=int32&gt;]
step/step [&lt;tf.Tensor &#39;step/step:0&#39; shape=() dtype=int32_ref&gt;]
step/step/Assign [&lt;tf.Tensor &#39;step/step/Assign:0&#39; shape=() dtype=int32_ref&gt;]
step/step/read [&lt;tf.Tensor &#39;step/step/read:0&#39; shape=() dtype=int32&gt;]
step/Assign [&lt;tf.Tensor &#39;step/Assign:0&#39; shape=() dtype=int32_ref&gt;]
</pre></div></td></tr></table></p>
<p>step数を記録するために用意したstep変数に関連する情報：pbファイル変換後</p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>prefix/step/step [&lt;tf.Tensor &#39;prefix/step/step:0&#39; shape=() dtype=int32&gt;]
</pre></div></td></tr></table></p>
<p>neural_network_model/Variable_1に関する情報：pbファイル変換前</p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class=code><div class=codehilite><pre><span></span>neural_network_model/Variable_1 [&lt;tf.Tensor &#39;neural_network_model/Variable_1:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/IsVariableInitialized [&lt;tf.Tensor &#39;neural_network_model/Variable_1/IsVariableInitialized:0&#39; shape=() dtype=bool&gt;]
neural_network_model/Variable_1/cond/Switch [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/Switch:0&#39; shape=() dtype=bool&gt;, &lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/Switch:1&#39; shape=() dtype=bool&gt;]
neural_network_model/Variable_1/cond/switch_t [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/switch_t:0&#39; shape=() dtype=bool&gt;]
neural_network_model/Variable_1/cond/switch_f [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/switch_f:0&#39; shape=() dtype=bool&gt;]
neural_network_model/Variable_1/cond/pred_id [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/pred_id:0&#39; shape=() dtype=bool&gt;]
neural_network_model/Variable_1/cond/read/Switch [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/read/Switch:0&#39; shape=(3, 11) dtype=float32_ref&gt;, &lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/read/Switch:1&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/cond/read [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/read:0&#39; shape=(3, 11) dtype=float32&gt;]
neural_network_model/Variable_1/cond/Switch_1 [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/Switch_1:0&#39; shape=(3, 11) dtype=float32&gt;, &lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/Switch_1:1&#39; shape=(3, 11) dtype=float32&gt;]
neural_network_model/Variable_1/cond/Merge [&lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/Merge:0&#39; shape=(3, 11) dtype=float32&gt;, &lt;tf.Tensor &#39;neural_network_model/Variable_1/cond/Merge:1&#39; shape=() dtype=int32&gt;]
neural_network_model/Variable_1/neural_network_model/Variable/read_neural_network_model/Variable_1_0 [&lt;tf.Tensor &#39;neural_network_model/Variable_1/neural_network_model/Variable/read_neural_network_model/Variable_1_0:0&#39; shape=(3, 11) dtype=float32&gt;]
neural_network_model/Variable_1/Assign [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Assign:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/read [&lt;tf.Tensor &#39;neural_network_model/Variable_1/read:0&#39; shape=(3, 11) dtype=float32&gt;]

neural_network_model/Variable_1/Adam/Initializer/zeros [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam/Initializer/zeros:0&#39; shape=(3, 11) dtype=float32&gt;]
neural_network_model/Variable_1/Adam [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/Adam/Assign [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam/Assign:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/Adam/read [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam/read:0&#39; shape=(3, 11) dtype=float32&gt;]
neural_network_model/Variable_1/Adam_1/Initializer/zeros [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam_1/Initializer/zeros:0&#39; shape=(3, 11) dtype=float32&gt;]
neural_network_model/Variable_1/Adam_1 [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam_1:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/Adam_1/Assign [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam_1/Assign:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
neural_network_model/Variable_1/Adam_1/read [&lt;tf.Tensor &#39;neural_network_model/Variable_1/Adam_1/read:0&#39; shape=(3, 11) dtype=float32&gt;]

train_op/update_neural_network_model/Variable_1/ApplyAdam [&lt;tf.Tensor &#39;train_op/update_neural_network_model/Variable_1/ApplyAdam:0&#39; shape=(3, 11) dtype=float32_ref&gt;]
</pre></div></td></tr></table></p>
<p>neural_network_model/Variable_1に関する情報：pbファイル変換後</p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>prefix/neural_network_model/Variable_1 [&lt;tf.Tensor &#39;prefix/neural_network_model/Variable_1:0&#39; shape=(3, 11) dtype=float32&gt;]
prefix/neural_network_model/Variable_1/read [&lt;tf.Tensor &#39;prefix/neural_network_model/Variable_1/read:0&#39; shape=(3, 11) dtype=float32&gt;]
</pre></div></td></tr></table></p>
<p>prefixはpb読み込み時に追加した接頭辞<br>
学習コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>Graph</span><span class=p>()</span><span class=o>.</span><span class=n>as_default</span><span class=p>()</span> <span class=k>as</span> <span class=n>graph</span><span class=p>:</span>
        <span class=n>tf</span><span class=o>.</span><span class=n>import_graph_def</span><span class=p>(</span>
            <span class=n>graph_def</span><span class=p>,</span> 
            <span class=n>input_map</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> 
            <span class=n>return_elements</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> 
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;prefix&quot;</span><span class=p>,</span> 
            <span class=n>op_dict</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> 
            <span class=n>producer_op_list</span><span class=o>=</span><span class=bp>None</span>
        <span class=p>)</span>
</pre></div></td></tr></table></p>
<hr>

<h4 id="_13">再利用可能な方法</h4>
<p>学習途中で保存したり、学習コード内で保存する際はcheckpointに保存します。
<hr></p>
<h4 id="checkpoint">checkpointに保存</h4>
<p>学習コードで途中経過や学習完了時に保存する時はcheckpointを使います。</p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>saver</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Saver</span><span class=p>(</span><span class=n>max_to_keep</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<span class=sd>&#39;&#39;&#39; 学習を実行 &#39;&#39;&#39;</span>
<span class=n>saver</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>sess</span><span class=p>,</span> <span class=n>MODEL_DIR</span> <span class=o>+</span> <span class=s1>&#39;/model-&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>step</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;.ckpt&#39;</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>checkpointはデフォルトでは最新5件までしか残さないため、長時間の学習を行う時はmax_to_keepの値を指定しておきます。<br>
例えば5000万ステップを学習する場合は、checkpointは100万ステップ毎に保存する感じで使います。<br></p>
<p>学習コード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>            <span class=c1># 1000000 step毎にsaveする</span>
            <span class=k>if</span> <span class=n>step</span> <span class=o>%</span> <span class=mi>1000000</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=n>_step</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>step_op</span><span class=p>,</span><span class=n>feed_dict</span><span class=o>=</span><span class=p>{</span><span class=n>placeholder_step</span><span class=p>:</span><span class=n>step</span><span class=p>})</span> <span class=c1># variable_stepにstepを記録する</span>
                <span class=n>saver</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>sess</span><span class=p>,</span> <span class=n>MODEL_DIR</span> <span class=o>+</span> <span class=s1>&#39;/model-&#39;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>step</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;.ckpt&#39;</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>checkpointへの保存で使うsaver.save()は、学習済みの値の他にモデル構成情報となるmeta_graphも出力します。
<hr></p>
<h4 id="checkpoint_1">checkpointを読み込む</h4>
<p>今回は、学習コードにモデルをフルスクラッチで書いているので、checkpointからのモデル情報の復元はスキップして、変数値だけを復元して再開します。<br>
学習コード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>saver</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>Saver</span><span class=p>(</span><span class=n>max_to_keep</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span> <span class=k>as</span> <span class=n>sess</span><span class=p>:</span>
    <span class=n>ckpt</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>get_checkpoint_state</span><span class=p>(</span><span class=n>MODEL_DIR</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>ckpt</span><span class=p>:</span>
        <span class=c1># checkpointファイルから最後に保存したモデルへのパスを取得する</span>
        <span class=n>last_model</span> <span class=o>=</span> <span class=n>ckpt</span><span class=o>.</span><span class=n>model_checkpoint_path</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&quot;load {}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>last_model</span><span class=p>))</span>
        <span class=c1># 学習済みモデルを読み込む</span>
        <span class=n>saver</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>sess</span><span class=p>,</span> <span class=n>last_model</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&quot;initialization&quot;</span><span class=p>)</span>
        <span class=c1># 初期化処理</span>
        <span class=n>init_op</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>global_variables_initializer</span><span class=p>()</span>
        <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>init_op</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>checkpointがある場合、学習済みの変数値をsaver.restore()で復元します。この時、checkpointのモデル情報と今のモデル情報が一致している必要があります。モデル情報を変更していると復元に失敗します。<br>
checkpointが無い場合は、tf.global_variables_initializer()でモデルの変数値を初期化します。
<hr></p>
<h4 id="_14">凍結する方法</h4>
<p>checkpointから復元した再学習可能なフルモデルデータでも予測は出来ますが、実行環境においては学習でしか使わない情報は無駄なので削り落として必要なものだけをpbファイルに保存したものを使います。<br>
<hr></p>
<h4 id="pb">pbファイルに保存</h4>
<blockquote>
<p><code>cd ./MLP/</code><br>
<code>python freeze_graph.py</code><br></p>
</blockquote>
<p>./MLP/model/car_model.pb ファイルが作成されます。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p><img alt="" src="document/freeze-design1.png" />
学習コードで学習済みモデルのpbファイルを作ろうとすると、学習時のセッションとは別のセッションを作成して変数値を再読み込みしないといけないため、pbファイルを作成するコードは学習コードとは別に用意します。<br>
<hr></p>
<p>予測時に使うOP名は、学習コードで付けた名前になります。tf.variable_scope()で名前スコープを付けた場合はスコープ名から必要になります。<br>
学習コード：<a href="MLP/train_model.py">./MLP/train_model.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>variable_scope</span><span class=p>(</span><span class=s2>&quot;queue&quot;</span><span class=p>):</span>
<span class=o>...</span>
    <span class=n>dequeue_input_data</span><span class=p>,</span> <span class=n>dequeue_input_target</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>dequeue_many</span><span class=p>(</span><span class=n>placeholder_batch_size</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;dequeue_op&#39;</span><span class=p>)</span> <span class=c1># instead of data/target placeholder</span>
</pre></div></td></tr></table></p>
<p>pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>OUTPUT_NODE_NAMES</span><span class=o>=</span><span class=s2>&quot;queue/dequeue_op,neural_network_model/output_y,neural_network_model/score,step/step&quot;</span>
</pre></div></td></tr></table></p>
<p>ここで名付けたdequeue_opは、予測実行時にdequeue_op:0をセンサー値入力用に使います。dequeue_op:1は正解ラベル用になりますが、予測に使うことはありません。</p>
<hr>

<p>OP名が分からない時は、表示されるOP名から推測してください。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<div class=md-fenced-code-tabs id=tab-tab-group-21><input name=tab-group-21 type=radio id=tab-group-21-0_python checked=checked class=code-tab data-lang=python aria-controls=tab-group-21-0_python-panel role=tab><label for=tab-group-21-0_python class=code-tab-label data-lang=python id=tab-group-21-0_python-label>Python</label><div class=code-tabpanel role=tabpanel data-lang=python id=tab-group-21-0_python-panel aria-labelledby=tab-group-21-0_python-label><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>print_graph_operations</span><span class=p>(</span><span class=n>graph</span><span class=p>):</span>
    <span class=c1># print operations</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;----- operations in graph -----&quot;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>op</span> <span class=ow>in</span> <span class=n>graph</span><span class=o>.</span><span class=n>get_operations</span><span class=p>():</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&quot;{} {}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>op</span><span class=o>.</span><span class=n>name</span><span class=p>,</span><span class=n>op</span><span class=o>.</span><span class=n>outputs</span><span class=p>))</span>
<span class=o>...</span>
        <span class=c1># print operations</span>
        <span class=n>print_graph_operations</span><span class=p>(</span><span class=n>graph</span><span class=p>)</span>
</pre></div></td></tr></table></div><input name=tab-group-21 type=radio id=tab-group-21-1_kkucksd95wrqs39 class=code-tab data-lang aria-controls=tab-group-21-1_kkucksd95wrqs39-panel role=tab><label for=tab-group-21-1_kkucksd95wrqs39 class=code-tab-label data-lang id=tab-group-21-1_kkucksd95wrqs39-label></label><div class=code-tabpanel role=tabpanel data-lang id=tab-group-21-1_kkucksd95wrqs39-panel aria-labelledby=tab-group-21-1_kkucksd95wrqs39-label><table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class=code><div class=codehilite><pre><span></span>----- operations in graph -----
input/input_data [&lt;tf.Tensor &#39;input/input_data:0&#39; shape=(?, 3) dtype=float32&gt;]
input/input_target [&lt;tf.Tensor &#39;input/input_target:0&#39; shape=&lt;unknown&gt; dtype=float32&gt;]
input/batch_size [&lt;tf.Tensor &#39;input/batch_size:0&#39; shape=&lt;unknown&gt; dtype=int32&gt;]
step/input_step [&lt;tf.Tensor &#39;step/input_step:0&#39; shape=&lt;unknown&gt; dtype=int32&gt;]
step/step/initial_value [&lt;tf.Tensor &#39;step/step/initial_value:0&#39; shape=() dtype=int32&gt;]
step/step [&lt;tf.Tensor &#39;step/step:0&#39; shape=() dtype=int32_ref&gt;]
step/step/Assign [&lt;tf.Tensor &#39;step/step/Assign:0&#39; shape=() dtype=int32_ref&gt;]
step/step/read [&lt;tf.Tensor &#39;step/step/read:0&#39; shape=() dtype=int32&gt;]
step/Assign [&lt;tf.Tensor &#39;step/Assign:0&#39; shape=() dtype=int32_ref&gt;]
</pre></div></td></tr></table></div></div>

<p>freeze_graph.pyは、他のモデルのcheckpointでも使うことが出来ます。
<hr></p>
<p>基本的に学習マシンと実行マシンは異なるため、通常はモデル構成情報からデバイス情報を削除してcheckpointからモデル構成を復元します。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>CLEAR_DEVICES</span><span class=o>=</span><span class=bp>True</span>
<span class=o>...</span>
        <span class=c1># Graphを読み込む</span>
        <span class=c1># We import the meta graph and retrieve a Saver</span>
        <span class=n>saver</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>import_meta_graph</span><span class=p>(</span><span class=n>last_model</span> <span class=o>+</span> <span class=s1>&#39;.meta&#39;</span><span class=p>,</span> <span class=n>clear_devices</span><span class=o>=</span><span class=n>CLEAR_DEVICES</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>tf.train.import_meta_graph()でモデル構成が復元され、さらにsaverが作成されます。<br>
<hr></p>
<p>モデル構成を読み込んだら、グラフ定義を取得します。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># We retrieve the protobuf graph definition</span>
        <span class=n>graph</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>get_default_graph</span><span class=p>()</span>
        <span class=n>graph_def</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>as_graph_def</span><span class=p>()</span>
</pre></div></td></tr></table></p>
<hr>

<p>学習済みの変数値を復元します。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=n>saver</span><span class=o>.</span><span class=n>restore</span><span class=p>(</span><span class=n>sess</span><span class=p>,</span> <span class=n>last_model</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<hr>

<p>必要なモデル情報だけに削り落とします。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># We use a built-in TF helper to export variables to constants</span>
        <span class=n>output_graph_def</span> <span class=o>=</span> <span class=n>graph_util</span><span class=o>.</span><span class=n>convert_variables_to_constants</span><span class=p>(</span>
            <span class=n>sess</span><span class=p>,</span> <span class=c1># The session is used to retrieve the weights</span>
            <span class=n>graph_def</span><span class=p>,</span> <span class=c1># The graph_def is used to retrieve the nodes</span>
            <span class=n>OUTPUT_NODE_NAMES</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>)</span> <span class=c1># The output node names are used to select the usefull nodes</span>
        <span class=p>)</span>
</pre></div></td></tr></table></p>
<hr>

<p>pbファイルにバイナリデータで保存します。<br>
pbファイル作成コード：<a href="MLP/freeze_graph.py">./MLP/freeze_graph.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=n>tf</span><span class=o>.</span><span class=n>train</span><span class=o>.</span><span class=n>write_graph</span><span class=p>(</span><span class=n>output_graph_def</span><span class=p>,</span> <span class=n>MODEL_DIR</span><span class=p>,</span>
                             <span class=n>FROZEN_MODEL_NAME</span><span class=p>,</span> <span class=n>as_text</span><span class=o>=</span><span class=bp>False</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>as_text=Trueにすると、テキストファイルで保存することが出来ます。</p>
<p><a name="6-4"></p>
<h4 id="pb_1">pbファイルを読み込む</h4>
<p>予測実行を行うアプリケーションでは、pbファイルを読み込んで予測を実行します。<br>
予測実行コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>load_graph</span><span class=p>(</span><span class=n>frozen_graph_filename</span><span class=p>):</span>
    <span class=c1># We load the protobuf file from the disk and parse it to retrieve the </span>
    <span class=c1># unserialized graph_def</span>
    <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>gfile</span><span class=o>.</span><span class=n>GFile</span><span class=p>(</span><span class=n>frozen_graph_filename</span><span class=p>,</span> <span class=s2>&quot;rb&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
        <span class=n>graph_def</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>GraphDef</span><span class=p>()</span>
        <span class=n>graph_def</span><span class=o>.</span><span class=n>ParseFromString</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>

    <span class=c1># Then, we can use again a convenient built-in function to import a graph_def into the </span>
    <span class=c1># current default Graph</span>
    <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>Graph</span><span class=p>()</span><span class=o>.</span><span class=n>as_default</span><span class=p>()</span> <span class=k>as</span> <span class=n>graph</span><span class=p>:</span>
        <span class=n>tf</span><span class=o>.</span><span class=n>import_graph_def</span><span class=p>(</span>
            <span class=n>graph_def</span><span class=p>,</span> 
            <span class=n>input_map</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> 
            <span class=n>return_elements</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> 
            <span class=n>name</span><span class=o>=</span><span class=s2>&quot;prefix&quot;</span><span class=p>,</span> 
            <span class=n>op_dict</span><span class=o>=</span><span class=bp>None</span><span class=p>,</span> 
            <span class=n>producer_op_list</span><span class=o>=</span><span class=bp>None</span>
        <span class=p>)</span>
    <span class=k>return</span> <span class=n>graph</span>

<span class=n>graph</span> <span class=o>=</span> <span class=n>load_graph</span><span class=p>(</span><span class=n>MODEL_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>FROZEN_MODEL_NAME</span><span class=p>)</span>
<span class=o>...</span>
<span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>Session</span><span class=p>(</span><span class=n>graph</span><span class=o>=</span><span class=n>graph</span><span class=p>)</span> <span class=k>as</span> <span class=n>sess</span><span class=p>:</span>
</pre></div></td></tr></table></p>
<p>モデルを読み込む際にname="prefix"でモデル毎にprefix名を付けておくと、複数のモデルを使う場合に区別しやすくなります。<br>
読み込んだモデル(graph)はtf.Session()の引数に渡します。<br>
<hr></p>
<p>予測実行で使う変数はオペレーション名から取得します。<br>
予測実行コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=n>input_x</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>get_tensor_by_name</span><span class=p>(</span><span class=s1>&#39;prefix/queue/dequeue_op:0&#39;</span><span class=p>)</span>
<span class=n>output_y</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>get_tensor_by_name</span><span class=p>(</span><span class=s1>&#39;prefix/neural_network_model/output_y:0&#39;</span><span class=p>)</span>
<span class=n>score</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>get_tensor_by_name</span><span class=p>(</span><span class=s1>&#39;prefix/neural_network_model/score:0&#39;</span><span class=p>)</span>
<span class=n>step</span> <span class=o>=</span> <span class=n>graph</span><span class=o>.</span><span class=n>get_tensor_by_name</span><span class=p>(</span><span class=s1>&#39;prefix/step/step:0&#39;</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<hr>

<p>pbファイルを読み込みオペレーションを用意したら、予測実行が出来るようになります。<br>
予測実行コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7
8</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>Session</span><span class=p>(</span><span class=n>graph</span><span class=o>=</span><span class=n>graph</span><span class=p>)</span> <span class=k>as</span> <span class=n>sess</span><span class=p>:</span>
<span class=o>...</span>
        <span class=c1># センサー値をランダムな0-1000の範囲で作成する</span>
        <span class=c1># sensors = [[LEFT45,FRONT,RIGHT45]]</span>
        <span class=n>sensors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1000</span><span class=p>,</span><span class=mi>3</span><span class=p>)])</span>

        <span class=c1># 予測を実行する</span>
        <span class=n>_output_y</span><span class=p>,</span><span class=n>_score</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=n>output_y</span><span class=p>,</span><span class=n>score</span><span class=p>],</span><span class=n>feed_dict</span><span class=o>=</span><span class=p>{</span><span class=n>input_x</span><span class=p>:</span><span class=n>sensors</span><span class=p>})</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='7'></p>
<h2 id="pythontensorflow_2">[Python/TensorFlow] 予測を実行</h2>
<p><img alt="" src="document/prediction-design1.png" />
<a href="#6-4">pbファイルを読み込む</a>で予測実行までを見ました。<br>
* モデルの読み込み<br>
* 入出力オペレーションの変数取得<br>
* 読み込んだモデルでセッションを開始<br>
* 入力値作成<br>
* 予測実行<br></p>
<p>最後に、予測結果から最も確率の高いものは何なのか？を知る必要があります。<br>
予測実行コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># 予測を実行する</span>
        <span class=n>_output_y</span><span class=p>,</span><span class=n>_score</span> <span class=o>=</span> <span class=n>sess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=n>output_y</span><span class=p>,</span><span class=n>score</span><span class=p>],</span><span class=n>feed_dict</span><span class=o>=</span><span class=p>{</span><span class=n>input_x</span><span class=p>:</span><span class=n>sensors</span><span class=p>})</span>
        <span class=c1># 予測結果から最も大きな値の配列番号を取得する</span>
        <span class=n>max_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>_output_y</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=c1># max_value: 0:STOP,1:LEFT,2:FORWARD,3:RIGHT</span>
        <span class=c1># そのスコアを取得する</span>
        <span class=n>max_score</span> <span class=o>=</span> <span class=n>_score</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>max_value</span><span class=p>]</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&quot;max_value:{} score:{} input:{}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>max_value</span><span class=p>,</span><span class=n>max_score</span><span class=p>,</span><span class=n>sensors</span><span class=p>))</span>
</pre></div></td></tr></table></p>
<p>max_valueが0:STOP,1:LEFT,2:FORWARD,3:RIGHTを示す予測結果となります。<br>
max_scoreはその点数で、1.0に近い方が強く結果を示していることになります。<br></p>
<hr>

<h4 id="_15">距離センサーから値を取得して予測を実行する</h4>
<p>入力値を実際の距離センサーから取得して予測を実行します。<br>
予測実行コード：<a href="MLP/run_ai_test.py">./MLP/run_ai_test.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=n>sensors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>1000</span><span class=p>,</span><span class=mi>3</span><span class=p>)])</span>
</pre></div></td></tr></table></p>
<p>この部分をセンサー値に書き換えればいいのですが、これまでの./MLP/ディレクトリは学習用としておいて、作成したモデル(pbファイル)は実行環境向けに場所にコピーします。<br></p>
<blockquote>
<p><code>mkdir ./model/</code><br>
<code>cp ./MLP/model/car_model.pb ./model/</code><br></p>
</blockquote>
<p>距離センサー値の取得方法はlevel_carと同じになります。<br>
TensorFlow部分はAIクラスとして書いてあります。<br>
距離センサーFabo #224 Distance用ライブラリ：<a href="fabolib/kerberos_vl53l0x.py">./fabolib/kerberos_vl53l0x.py</a><br>
距離センサーLidarLite v3用ライブラリ：<a href="fabolib/kerberos.py">./fabolib/kerberos.py</a><br>
AIライブラリ：<a href="lib/ai.py">./lib/ai.py</a><br>
予測実行コード：<a href="run_ai.py">./run_ai.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>fabolib.kerberos_vl53l0x</span> <span class=kn>import</span> <span class=n>KerberosVL53L0X</span> <span class=k>as</span> <span class=n>Kerberos</span>
<span class=o>...</span>
    <span class=c1># 距離センサー準備</span>
    <span class=n>kerberos</span> <span class=o>=</span> <span class=n>Kerberos</span><span class=p>()</span>
    <span class=c1># Lidar取得間隔(秒)</span>
    <span class=n>LIDAR_INTERVAL</span> <span class=o>=</span> <span class=mf>0.05</span>
<span class=o>...</span>
            <span class=c1>########################################</span>
            <span class=c1># 距離センサー値を取得する</span>
            <span class=c1>########################################</span>
            <span class=n>distance1</span><span class=p>,</span><span class=n>distance2</span><span class=p>,</span><span class=n>distance3</span> <span class=o>=</span> <span class=n>kerberos</span><span class=o>.</span><span class=n>get_distance</span><span class=p>()</span>
            <span class=n>sensors</span> <span class=o>=</span> <span class=p>[</span><span class=n>distance1</span><span class=p>,</span><span class=n>distance2</span><span class=p>,</span><span class=n>distance3</span><span class=p>]</span>
</pre></div></td></tr></table></p>
<blockquote>
<p><code>python run_ai.py</code><br></p>
</blockquote>
<p>このコードを実行するには、Fabo #902 Kerberos基板とFabo #224 Distanceが必要になります。<br>
LidarLite v3を使っている場合は、import部分を以下のように変更してください。<br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>from</span> <span class=nn>fabolib.kerberos</span> <span class=kn>import</span> <span class=n>Kerberos</span>
<span class=c1>#from fabolib.kerberos_vl53l0x import KerberosVL53L0X as Kerberos</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='8'></p>
<h2 id="pythontensorflow_3">[Python/TensorFlow] 予測精度を評価</h2>
<p>入力値はfor文で生成可能で、対応する正解ラベルはIF文で求めることが出来るため、網羅的に予測を実行し、IF文の結果と比較することで精度を評価してみることにします。<br></p>
<p>一度に400000件の入力データを作成し、予測にかけます。1件ずつ予測するよりも速く予測出来ます。<br>
予測実行コード：<a href="run_ai_eval.py">./run_ai_eval.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=c1># 評価する距離範囲</span>
    <span class=n>MIN_RANGE</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>MAX_RANGE</span> <span class=o>=</span> <span class=mi>200</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>learned_step</span> <span class=o>=</span> <span class=n>ai</span><span class=o>.</span><span class=n>get_learned_step</span><span class=p>()</span>
        <span class=k>print</span><span class=p>(</span><span class=s2>&quot;learned_step:{}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>learned_step</span><span class=p>))</span>

        <span class=c1>########################################</span>
        <span class=c1># 距離センサー値を生成する</span>
        <span class=c1>########################################</span>
        <span class=n>sensors</span><span class=o>=</span><span class=p>[]</span>
        <span class=k>for</span> <span class=n>distance1</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>MIN_RANGE</span><span class=p>,</span><span class=n>MAX_RANGE</span><span class=p>):</span>
            <span class=k>for</span> <span class=n>distance2</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>MIN_RANGE</span><span class=p>,</span><span class=n>MAX_RANGE</span><span class=p>):</span>
                <span class=k>for</span> <span class=n>distance3</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>MIN_RANGE</span><span class=p>,</span><span class=n>MAX_RANGE</span><span class=p>):</span>
                    <span class=n>sensors</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>distance1</span><span class=p>,</span><span class=n>distance2</span><span class=p>,</span><span class=n>distance3</span><span class=p>])</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>distance1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=n>sensors</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>sensors</span><span class=p>)</span>

                <span class=c1>########################################</span>
                <span class=c1># AI予測結果を取得する</span>
                <span class=c1>########################################</span>
                <span class=c1># 今回の予測結果を取得する</span>
                <span class=n>ai_values</span> <span class=o>=</span> <span class=n>ai</span><span class=o>.</span><span class=n>get_predictions</span><span class=p>(</span><span class=n>sensors</span><span class=p>,</span><span class=n>SCORE</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>ジェネレータは一気に複数行を計算出来ないので、予測結果と一件ずつ比較します。<br>
予測実行コード：<a href="run_ai_eval.py">./run_ai_eval.py</a></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class=code><div class=codehilite><pre><span></span>                <span class=n>n_rows</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sensors</span><span class=p>)</span>
                <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n_rows</span><span class=p>):</span>
                    <span class=n>counter</span> <span class=o>+=</span><span class=mi>1</span>
                    <span class=c1># 予測結果のスコアが低かった回数をカウントする</span>
                    <span class=k>if</span> <span class=n>ai_values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>ai</span><span class=o>.</span><span class=n>get_other_label</span><span class=p>():</span>
                        <span class=n>bad_score_counter</span> <span class=o>+=</span> <span class=mi>1</span>

                    <span class=c1>########################################</span>
                    <span class=c1># IF結果を取得する</span>
                    <span class=c1>########################################</span>
                    <span class=c1># 今回の結果を取得する</span>
                    <span class=n>generator_result</span> <span class=o>=</span> <span class=n>generator</span><span class=o>.</span><span class=n>get_label</span><span class=p>(</span><span class=n>sensors</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
                    <span class=n>if_value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>generator_result</span><span class=p>)</span>

                    <span class=c1># 予測結果とジェネレータ結果が異なった回数をカウントする</span>
                    <span class=k>if</span> <span class=ow>not</span> <span class=n>if_value</span> <span class=o>==</span> <span class=n>ai_values</span><span class=p>[</span><span class=n>i</span><span class=p>]:</span>
                        <span class=n>miss_counter</span> <span class=o>+=</span> <span class=mi>1</span>
                        <span class=c1># 不一致の予測結果をコンソールに表示する</span>
                        <span class=n>print_log</span><span class=p>(</span><span class=n>sensors</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>ai</span><span class=p>,</span><span class=n>ai_values</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>if_value</span><span class=p>,</span><span class=n>counter</span><span class=p>,</span><span class=n>miss_counter</span><span class=p>,</span><span class=n>bad_score_counter</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<hr>

<p>学習範囲(0-199)の評価は精度はかなりよくなりますが、800万件の予測を実行するのでJetson TX2でそこそこ時間がかかります。<br>
読み込むモデルはAIクラスを初期化する際に変更できます。<br>
評価実行コード：<a href="run_ai_eval.py">./run_ai_eval.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=c1># AI準備</span>
    <span class=n>ai</span> <span class=o>=</span> <span class=n>AI</span><span class=p>(</span><span class=s2>&quot;car_model.pb&quot;</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<blockquote>
<p><code>time python ./run_ai_eval.py &gt; eval.log</code><br>
real  11m12.715s<br>
user  11m11.452s<br>
sys   0m5.844s<br></p>
</blockquote>
<p><em>学習範囲(0-199)</em></p>
<table>
<thead>
<tr>
<th>学習ステップ数</th>
<th>精度</th>
<th>不一致件数</th>
<th>低スコア件数</th>
</tr>
</thead>
<tbody>
<tr>
<td>10M</td>
<td>0.999633875</td>
<td>2929</td>
<td>2890</td>
</tr>
<tr>
<td>20M</td>
<td>0.9999945</td>
<td>44</td>
<td>14</td>
</tr>
<tr>
<td>30M</td>
<td>0.999986</td>
<td>112</td>
<td>102</td>
</tr>
<tr>
<td>40M</td>
<td>0.999991875</td>
<td>65</td>
<td>51</td>
</tr>
<tr>
<td>50M</td>
<td>0.99979775</td>
<td>1618</td>
<td>1176</td>
</tr>
</tbody>
</table>
<hr>

<p>学習範囲外(0-399から学習範囲を除外)の精度の評価はデータ件数が5600万件と多いためJetson TX2ではかなり時間がかかります。<br></p>
<blockquote>
<p><code>time python ./run_ai_eval_400.py &gt; eval_400.log</code><br>
real    77m28.863s<br>
user    77m24.504s<br>
sys     0m33.284s<br></p>
</blockquote>
<p><em>学習範囲外(0-399から学習範囲を除外)</em></p>
<table>
<thead>
<tr>
<th>学習ステップ数</th>
<th>精度</th>
<th>不一致件数</th>
<th>低スコア件数</th>
</tr>
</thead>
<tbody>
<tr>
<td>10M</td>
<td>0.91746125</td>
<td>4622170</td>
<td>116278</td>
</tr>
<tr>
<td>20M</td>
<td>0.9027016071428572</td>
<td>5448710</td>
<td>59344</td>
</tr>
<tr>
<td>30M</td>
<td>0.9085851071428571</td>
<td>5119234</td>
<td>74547</td>
</tr>
<tr>
<td>40M</td>
<td>0.9152485535714285</td>
<td>4746081</td>
<td>30425</td>
</tr>
<tr>
<td>50M</td>
<td>0.9193687857142857</td>
<td>4515348</td>
<td>40832</td>
</tr>
</tbody>
</table>
<hr>

<p>この評価結果はとても興味深いことを示しています。<br>
50Mステップまでで見てみると、20Mステップは学習範囲内のデータで精度がよくなっていますが、学習範囲外では50Mステップより精度が悪いことが分かります。<br>
学習時に記録したTensorBoardのlossの値も見てみます。<br>
<img alt="" src="document/tensorboard1.png" /></p>
<p>学習ステップを重ねることで、lossが減ってきているように見えるので、トータル的には学習ステップを重ねれば精度が上がるのではないかと思われます。<br></p>
<p>もう少し学習を進めてみます。<br></p>
<p><em>学習範囲(0-199)</em></p>
<table>
<thead>
<tr>
<th>学習ステップ数</th>
<th>精度</th>
<th>不一致件数</th>
<th>低スコア件数</th>
</tr>
</thead>
<tbody>
<tr>
<td>60M</td>
<td>0.999956625</td>
<td>347</td>
<td>344</td>
</tr>
<tr>
<td>70M</td>
<td>0.99999925</td>
<td>6</td>
<td>2</td>
</tr>
<tr>
<td>80M</td>
<td>0.999999625</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>90M</td>
<td>0.99999925</td>
<td>6</td>
<td>1</td>
</tr>
<tr>
<td>100M</td>
<td>0.999999625</td>
<td>3</td>
<td>0</td>
</tr>
<tr>
<td>110M</td>
<td>0.999999625</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>120M</td>
<td>0.9999995</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>130M</td>
<td>0.99999925</td>
<td>6</td>
<td>2</td>
</tr>
<tr>
<td>140M</td>
<td>0.999998875</td>
<td>9</td>
<td>3</td>
</tr>
<tr>
<td>150M</td>
<td>0.9999995</td>
<td>4</td>
<td>0</td>
</tr>
</tbody>
</table>
<hr>

<p><em>学習範囲外(0-399から学習範囲を除外)</em></p>
<table>
<thead>
<tr>
<th>学習ステップ数</th>
<th>精度</th>
<th>不一致件数</th>
<th>低スコア件数</th>
</tr>
</thead>
<tbody>
<tr>
<td>60M</td>
<td>0.9232642142857143</td>
<td>4297204</td>
<td>42645</td>
</tr>
<tr>
<td>70M</td>
<td>0.9267239285714286</td>
<td>4103460</td>
<td>31735</td>
</tr>
<tr>
<td>80M</td>
<td>0.9253654285714286</td>
<td>4179536</td>
<td>31836</td>
</tr>
<tr>
<td>90M</td>
<td>0.9089407857142857</td>
<td>5099316</td>
<td>45796</td>
</tr>
<tr>
<td>100M</td>
<td>0.907304625</td>
<td>5190941</td>
<td>47454</td>
</tr>
<tr>
<td>110M</td>
<td>0.913579625</td>
<td>4839541</td>
<td>40684</td>
</tr>
<tr>
<td>120M</td>
<td>0.9103865714285714</td>
<td>5018352</td>
<td>39680</td>
</tr>
<tr>
<td>130M</td>
<td>0.9080933928571429</td>
<td>5146770</td>
<td>43341</td>
</tr>
<tr>
<td>140M</td>
<td>0.9049904107142858</td>
<td>5320537</td>
<td>44950</td>
</tr>
<tr>
<td>150M</td>
<td>0.9081959821428571</td>
<td>5141025</td>
<td>41063</td>
</tr>
</tbody>
</table>
<hr>

<p><img alt="" src="document/tensorboard2.png" />
<img alt="" src="document/tensorboard3.png" /></p>
<hr>

<p>70Mステップで学習範囲内の精度と学習範囲外の精度の両方が頭打ちになり、その後は学習範囲外で2%程の精度差が出ています。<br>
学習範囲内での誤判定箇所を見てみると、大体同じデータを間違えているようです。<br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80</pre></div></td><td class=code><div class=codehilite><pre><span></span>ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_70M.log 
learned_step:70000000
accuracy:0.9999984462809404 total:643617 miss:1 bad score:0 result:STOP [16 18 16] - ng generator:FORWARD
accuracy:0.9999970743167432 total:683601 miss:2 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.9999956114815346 total:683602 miss:3 bad score:0 result:FORWARD [17 18  1] - ng generator:LEFT
accuracy:0.9999941503449102 total:683801 miss:4 bad score:0 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.9999926900691666 total:684001 miss:5 bad score:1 result:BAD SCORE [17 20  0] - ng generator:LEFT
accuracy:0.9999912283010096 total:684018 miss:6 bad score:2 result:BAD SCORE [17 20 17] - ng generator:RIGHT
accuracy:0.99999925 total:8000000 miss:6 bad score:2
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_80M.log 
learned_step:80000000
accuracy:0.9999984462809404 total:643617 miss:1 bad score:1 result:BAD SCORE [16 18 16] - ng generator:FORWARD
accuracy:0.9999970743167432 total:683601 miss:2 bad score:1 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.999999624065191 total:7980107 miss:3 bad score:2 result:BAD SCORE [199 100 106] - ng generator:LEFT
accuracy:0.999999625 total:8000000 miss:3 bad score:2
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_90M.log 
learned_step:90000000
accuracy:0.9999984462809404 total:643617 miss:1 bad score:0 result:STOP [16 18 16] - ng generator:FORWARD
accuracy:0.9999970743167432 total:683601 miss:2 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.9999956127586828 total:683801 miss:3 bad score:0 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.9999994987535253 total:7980106 miss:4 bad score:1 result:BAD SCORE [199 100 105] - ng generator:LEFT
accuracy:0.9999993734419852 total:7980107 miss:5 bad score:1 result:FORWARD [199 100 106] - ng generator:LEFT
accuracy:0.9999992481492254 total:7980307 miss:6 bad score:1 result:FORWARD [199 101 106] - ng generator:LEFT
accuracy:0.99999925 total:8000000 miss:6 bad score:1
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_100M.log 
learned_step:100000000
accuracy:0.9999984462809404 total:643617 miss:1 bad score:0 result:STOP [16 18 16] - ng generator:FORWARD
accuracy:0.9999970743167432 total:683601 miss:2 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.999999624065191 total:7980107 miss:3 bad score:0 result:FORWARD [199 100 106] - ng generator:LEFT
accuracy:0.999999625 total:8000000 miss:3 bad score:0
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_110M.log 
learned_step:110000000
accuracy:0.9999985371583716 total:683601 miss:1 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.999997074321023 total:683602 miss:2 bad score:1 result:BAD SCORE [17 18  1] - ng generator:LEFT
accuracy:0.9999956127586828 total:683801 miss:3 bad score:1 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.999999625 total:8000000 miss:3 bad score:1
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_120M.log 
learned_step:120000000
accuracy:0.9999985371583716 total:683601 miss:1 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.999997074321023 total:683602 miss:2 bad score:1 result:BAD SCORE [17 18  1] - ng generator:LEFT
accuracy:0.9999956127586828 total:683801 miss:3 bad score:1 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.9999994987535882 total:7980107 miss:4 bad score:2 result:BAD SCORE [199 100 106] - ng generator:LEFT
accuracy:0.9999995 total:8000000 miss:4 bad score:2
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_130M.log 
learned_step:130000000
accuracy:0.9999985371583716 total:683601 miss:1 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.999997074321023 total:683602 miss:2 bad score:1 result:BAD SCORE [17 18  1] - ng generator:LEFT
accuracy:0.9999956127586828 total:683801 miss:3 bad score:1 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.999999069853967 total:4300400 miss:4 bad score:2 result:BAD SCORE [107 101 199] - ng generator:FORWARD
accuracy:0.9999993734419852 total:7980107 miss:5 bad score:2 result:FORWARD [199 100 106] - ng generator:LEFT
accuracy:0.9999992481492254 total:7980307 miss:6 bad score:2 result:FORWARD [199 101 106] - ng generator:LEFT
accuracy:0.99999925 total:8000000 miss:6 bad score:2
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_140M.log 
learned_step:140000000
accuracy:0.9999985371583716 total:683601 miss:1 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.999997074321023 total:683602 miss:2 bad score:1 result:BAD SCORE [17 18  1] - ng generator:LEFT
accuracy:0.9999956127586828 total:683801 miss:3 bad score:1 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.9999941520553333 total:684001 miss:4 bad score:2 result:BAD SCORE [17 20  0] - ng generator:LEFT
accuracy:0.9999993703014254 total:7940307 miss:5 bad score:3 result:BAD SCORE [198 101 106] - ng generator:LEFT
accuracy:0.999999248130288 total:7980106 miss:6 bad score:3 result:FORWARD [199 100 105] - ng generator:LEFT
accuracy:0.9999991228187792 total:7980107 miss:7 bad score:3 result:FORWARD [199 100 106] - ng generator:LEFT
accuracy:0.9999989975323005 total:7980307 miss:8 bad score:3 result:FORWARD [199 101 106] - ng generator:LEFT
accuracy:0.9999988722521013 total:7980507 miss:9 bad score:3 result:FORWARD [199 102 106] - ng generator:LEFT
accuracy:0.999998875 total:8000000 miss:9 bad score:3
main end
ubuntu@tegra-ubuntu:~/notebooks/github/RobotCarAI/level1_sensors$ cat eval_150M.log 
learned_step:150000000
accuracy:0.9999985371583716 total:683601 miss:1 bad score:0 result:FORWARD [17 18  0] - ng generator:LEFT
accuracy:0.9999970751724552 total:683801 miss:2 bad score:0 result:FORWARD [17 19  0] - ng generator:LEFT
accuracy:0.999999624065191 total:7980107 miss:3 bad score:0 result:FORWARD [199 100 106] - ng generator:LEFT
accuracy:0.9999994987661502 total:7980307 miss:4 bad score:0 result:FORWARD [199 101 106] - ng generator:LEFT
accuracy:0.9999995 total:8000000 miss:4 bad score:0
main end
</pre></div></td></tr></table></p>
<hr>

<p>この学習では、これ以上続けても学習成果は上がりそうにありません。<br>
Neural Netwoksを使った学習では、学習の止め時も考えるポイントになります。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='9'></p>
<h2 id="_16">ディレクトリとファイルについて</h2>
<ul>
<li>ディレクトリについて<br></li>
<li>document/ ドキュメント関連<br></li>
<li>fabolib/ Fabo製基板関連<br></li>
<li>generator/ 学習データのラベル生成関連<br></li>
<li>lib/ 予測関連<br></li>
<li>MLP/ 学習とpbファイル作成関連<br></li>
<li>model/ 学習済みモデル置き場<br></li>
<li>ファイルについて<br></li>
<li>README.md このファイル<br></li>
<li>run_ai_eval.py 学習範囲内の予測精度評価用コード<br></li>
<li>run_ai_eval_400.py 学習範囲外の予測精度評価用コード<br></li>
<li>run_ai.py センサー値を取得して予測を実行するコード。Fabo #902、LidarLite v3が必要。<br></li>
<li>MLP/train_model.py 学習実行コード<br><ul>
<li>MLP/log/にTensorboard用のログファイルが出力される<br></li>
<li>MLP/model/にcheckpointファイルが出力される<br></li>
</ul>
</li>
<li>MLP/freeze_graph.py pbファイル作成コード<br><ul>
<li>MLP/model/car_model.pbファイルを作成する<br></li>
</ul>
</li>
<li>MLP/run_ai_test.py ランダム値を入力値として予測を実行するコード<br></li>
</ul>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../02.level1_car/" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前
                </span>
                Index
              </span>
            </div>
          </a>
        
        
          <a href="../04.level1_demo/" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  次
                </span>
                Index
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>