



<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="クリップボードへコピー">
      
        <meta name="lang:clipboard.copied" content="コピーしました">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="何も見つかりませんでした">
      
        <meta name="lang:search.result.one" content="1件見つかりました">
      
        <meta name="lang:search.result.other" content="#件見つかりました">
      
        <meta name="lang:search.tokenizer" content="[\s\-　、。，．]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Index - FaBo RobotCarAI Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#4opencv" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="FaBo RobotCarAI Docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              FaBo RobotCarAI Docs
            </span>
            <span class="md-header-nav__topic">
              Index
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="FaBo RobotCarAI Docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    FaBo RobotCarAI Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      00.install raspberry pi3
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        00.install raspberry pi3
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../00.install_raspberry_pi3/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      01.fabodrive
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        01.fabodrive
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01.fabodrive/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      02.level1 car
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        02.level1 car
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../02.level1_car/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      03.level1 sensors
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        03.level1 sensors
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../03.level1_sensors/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      04.level1 demo
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        04.level1 demo
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../04.level1_demo/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      05.level2 lane detection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        05.level2 lane detection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../05.level2_lane_detection/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      06.level2 demo
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        06.level2 demo
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../06.level2_demo/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      07.level2 demo socket
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        07.level2 demo socket
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../07.level2_demo_socket/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      08.level3 object detection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        08.level3 object detection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../08.level3_object_detection/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      09.level3 demo socket
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        09.level3 demo socket
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../09.level3_demo_socket/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      10.level3 demo streaming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        10.level3 demo streaming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../10.level3_demo_streaming/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12" checked>
    
    <label class="md-nav__link" for="nav-12">
      11.level4 lane detection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        11.level4 lane detection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Index
      </label>
    
    <a href="./" title="Index" class="md-nav__link md-nav__link--active">
      Index
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目次</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="カメラ映像を取得し、レーンを検出する" class="md-nav__link">
    カメラ映像を取得し、レーンを検出する
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-region-of-interest" title="[Python/OpenCV] Region Of Interest" class="md-nav__link">
    [Python/OpenCV] Region Of Interest
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pythonopencv" title="[Python/OpenCV] 座標を探す" class="md-nav__link">
    [Python/OpenCV] 座標を探す
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" title="処理" class="md-nav__link">
    処理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="考察" class="md-nav__link">
    考察
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-inverse-perspective-mapping" title="[Python/OpenCV] Inverse Perspective Mapping" class="md-nav__link">
    [Python/OpenCV] Inverse Perspective Mapping
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pythonopencv_1" title="[Python/OpenCV] 座標を探す" class="md-nav__link">
    [Python/OpenCV] 座標を探す
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pythonopencv_2" title="[Python/OpenCV] 処理" class="md-nav__link">
    [Python/OpenCV] 処理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pythonopencv_3" title="[Python/OpenCV] 逆変換" class="md-nav__link">
    [Python/OpenCV] 逆変換
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="考察" class="md-nav__link">
    考察
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_4" title="[Python/OpenCV] 白色フィルタ" class="md-nav__link">
    [Python/OpenCV] 白色フィルタ
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pythonopencv_5" title="[Python/OpenCV] 処理" class="md-nav__link">
    [Python/OpenCV] 処理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="考察" class="md-nav__link">
    考察
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" title="2値化" class="md-nav__link">
    2値化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" title="処理" class="md-nav__link">
    処理
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-histogram" title="[Python/OpenCV] histogram" class="md-nav__link">
    [Python/OpenCV] histogram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-sliding-windows" title="[Python/OpenCV] Sliding Windows" class="md-nav__link">
    [Python/OpenCV] Sliding Windows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_6" title="[Python/OpenCV] ライン検出" class="md-nav__link">
    [Python/OpenCV] ライン検出
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_7" title="[Python/OpenCV] 弧の角度と傾き角" class="md-nav__link">
    [Python/OpenCV] 弧の角度と傾き角
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" title="円の中心座標の求め方" class="md-nav__link">
    円の中心座標の求め方
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_8" title="[Python/OpenCV] ピクセル座標と実座標" class="md-nav__link">
    [Python/OpenCV] ピクセル座標と実座標
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_9" title="[Python/OpenCV] 中央線までの距離" class="md-nav__link">
    [Python/OpenCV] 中央線までの距離
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_10" title="[Python/OpenCV] 描画" class="md-nav__link">
    [Python/OpenCV] 描画
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" title="[ディレクトリとファイルについて]" class="md-nav__link">
    [ディレクトリとファイルについて]
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      12.level5 demo streaming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        12.level5 demo streaming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../12.level5_demo_streaming/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目次</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="カメラ映像を取得し、レーンを検出する" class="md-nav__link">
    カメラ映像を取得し、レーンを検出する
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-region-of-interest" title="[Python/OpenCV] Region Of Interest" class="md-nav__link">
    [Python/OpenCV] Region Of Interest
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pythonopencv" title="[Python/OpenCV] 座標を探す" class="md-nav__link">
    [Python/OpenCV] 座標を探す
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" title="処理" class="md-nav__link">
    処理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="考察" class="md-nav__link">
    考察
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-inverse-perspective-mapping" title="[Python/OpenCV] Inverse Perspective Mapping" class="md-nav__link">
    [Python/OpenCV] Inverse Perspective Mapping
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pythonopencv_1" title="[Python/OpenCV] 座標を探す" class="md-nav__link">
    [Python/OpenCV] 座標を探す
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pythonopencv_2" title="[Python/OpenCV] 処理" class="md-nav__link">
    [Python/OpenCV] 処理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pythonopencv_3" title="[Python/OpenCV] 逆変換" class="md-nav__link">
    [Python/OpenCV] 逆変換
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="考察" class="md-nav__link">
    考察
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_4" title="[Python/OpenCV] 白色フィルタ" class="md-nav__link">
    [Python/OpenCV] 白色フィルタ
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pythonopencv_5" title="[Python/OpenCV] 処理" class="md-nav__link">
    [Python/OpenCV] 処理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="考察" class="md-nav__link">
    考察
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" title="2値化" class="md-nav__link">
    2値化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" title="処理" class="md-nav__link">
    処理
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-histogram" title="[Python/OpenCV] histogram" class="md-nav__link">
    [Python/OpenCV] histogram
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv-sliding-windows" title="[Python/OpenCV] Sliding Windows" class="md-nav__link">
    [Python/OpenCV] Sliding Windows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_6" title="[Python/OpenCV] ライン検出" class="md-nav__link">
    [Python/OpenCV] ライン検出
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_7" title="[Python/OpenCV] 弧の角度と傾き角" class="md-nav__link">
    [Python/OpenCV] 弧の角度と傾き角
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" title="円の中心座標の求め方" class="md-nav__link">
    円の中心座標の求め方
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_8" title="[Python/OpenCV] ピクセル座標と実座標" class="md-nav__link">
    [Python/OpenCV] ピクセル座標と実座標
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_9" title="[Python/OpenCV] 中央線までの距離" class="md-nav__link">
    [Python/OpenCV] 中央線までの距離
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pythonopencv_10" title="[Python/OpenCV] 描画" class="md-nav__link">
    [Python/OpenCV] 描画
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" title="[ディレクトリとファイルについて]" class="md-nav__link">
    [ディレクトリとファイルについて]
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <p><a name='top'></p>
<p>【タイトル】</p>
<h1 id="4opencv">レベル4：OpenCVでレーンを検出する</h1>
<hr>

<p>【目標】</p>
<h4 id="_1">カメラ映像を取得し、レーンを検出する</h4>
<p>【画像】<br>
<img alt="" src="document/result_frame_276.jpg" /><br></p>
<p>【動画】<br>
入力動画：<a href="demo_lane/input1.mp4">./demo_lane/input1.mp4</a><br>
出力動画：<a href="document/result_output1.mp4">./document/result_output1.mp4</a><br>
<a href="https://www.youtube.com/watch?v=xAi_31IcyZ0"><img alt="出力動画" src="https://img.youtube.com/vi/xAi_31IcyZ0/1.jpg" /></a><br></p>
<p>【参考】<br>
Programmatic lane finding: <a href="https://github.com/BillZito/lane-detection">https://github.com/BillZito/lane-detection</a>
<hr></p>
<p><a name='0'></p>
<p>【目次】<br>
* [Python/OpenCV] <a href="#1">Region Of Interst</a><br>
  * [Python/OpenCV] [座標を探す]<br>
  * [Python/OpenCV] [処理]<br>
  * 考察<br>
* [Python/OpenCV] <a href="#2">Inverse Perspective Mapping</a><br>
  * [Python/OpenCV] [座標を探す]<br>
  * [Python/OpenCV] [処理]<br>
  * [Python/OpenCV] [逆変換]<br>
  * 考察<br>
* [Python/OpenCV] <a href="#3">白色フィルタ</a><br>
  * [Python/OpenCV] [処理]<br>
  * 考察<br>
* [Python/OpenCV] <a href="#4">2値化</a><br>
  * [Python/OpenCV] [処理]<br>
* [Python/OpenCV] <a href="#5">histogram</a><br>
  * [Python/OpenCV] [処理]<br>
* [Python/OpenCV] <a href="#6">Sliding Windows</a><br>
* [Python/OpenCV] <a href="#7">ライン検出</a><br>
* [Python/OpenCV] <a href="#8">弧の角度と傾き角</a><br>
  * [Python/OpenCV] 円の中心座標の求め方<br>
* [Python/OpenCV] <a href="#9">ピクセル座標と実座標</a><br>
* [Python/OpenCV] <a href="#10">中央線までの距離</a><br>
* [Python/OpenCV] <a href="#11">描画</a><br>
* <a href="#12">ディレクトリとファイルについて</a><br>
<hr></p>
<p><a name='1'></p>
<h2 id="pythonopencv-region-of-interest">[Python/OpenCV] Region Of Interest</h2>
<p>Region Of Interst(ROI)は、画像内で必要になる領域が含まれている部分を抽出します。<br>
次に行うInverse Perspective Mappingと同じ座標とするので、直線が映っている画像で範囲を考えます。<br>
<img alt="" src="document/frame_86.jpg" />
<img alt="" src="document/result_frame_86_before_roi.jpg" />
<img alt="" src="document/result_frame_86_after_roi.jpg" />
<img alt="" src="document/result_frame_86_roi.jpg" /><br>
<hr></p>
<h4 id="pythonopencv">[Python/OpenCV] 座標を探す</h4>
<p>座標は直線に沿って領域が見えるように探します。<br>
<img alt="" src="document/result_frame_86_before_roi_sample.jpg" />
<img alt="" src="document/result_frame_86_after_roi_sample.jpg" />
<img alt="" src="document/result_frame_86_roi_sample.jpg" /><br>
ソースコード：<a href="to_region_of_interest.py">./to_region_of_interest.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># sample</span>
        <span class=n>roi_vertices</span> <span class=o>=</span> <span class=n>calc_roi_vertices</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span>
                                         <span class=n>top_width_rate</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span><span class=n>top_height_position</span><span class=o>=</span><span class=mf>0.15</span><span class=p>,</span>
                                         <span class=n>bottom_width_rate</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span><span class=n>bottom_height_position</span><span class=o>=</span><span class=mf>0.9</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>次に示すのは極端な例ですが、ロボットカーのカメラ画像だと、範囲内に白線が入らないケースがあります。<br>
<img alt="" src="document/result_capture-2_before_ipm_sample.jpg" /></p>
<p>そこで、ここでは画面範囲よりも広く範囲を取るようにします。<br>
<img alt="" src="document/result_frame_86_before_roi.jpg" />
<img alt="" src="document/result_frame_86_after_roi.jpg" />
<img alt="" src="document/result_frame_86_roi.jpg" /><br>
ソースコード：<a href="to_region_of_interest.py">./to_region_of_interest.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># robocar camera demo_lane</span>
        <span class=n>roi_vertices</span> <span class=o>=</span> <span class=n>calc_roi_vertices</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span>
                                         <span class=n>top_width_rate</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span><span class=n>top_height_position</span><span class=o>=</span><span class=mf>0.15</span><span class=p>,</span>
                                         <span class=n>bottom_width_rate</span><span class=o>=</span><span class=mf>2.0</span><span class=p>,</span><span class=n>bottom_height_position</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<hr>

<h4 id="_2">処理</h4>
<p>座標からポリゴン領域でマスク用イメージを作成し、入力画像からその範囲だけを抜き取ります。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>to_roi</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span> <span class=n>vertices</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Region Of Interest</span>
<span class=sd>    頂点座標でmaskを作り、入力画像に適用する</span>
<span class=sd>    args:</span>
<span class=sd>        cv_bgr: OpenCV BGR画像データ</span>
<span class=sd>        vertices: 領域の頂点座標</span>
<span class=sd>    return:</span>
<span class=sd>        cv_bgr_result: 領域外を黒くしたOpenCV BGR画像データ</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>mask</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>)</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>mask</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span><span class=o>==</span><span class=mi>2</span><span class=p>:</span>
        <span class=n>cv2</span><span class=o>.</span><span class=n>fillPoly</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>vertices</span><span class=p>,</span> <span class=mi>255</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>cv2</span><span class=o>.</span><span class=n>fillPoly</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>vertices</span><span class=p>,</span> <span class=p>(</span><span class=mi>255</span><span class=p>,)</span><span class=o>*</span><span class=n>mask</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=c1># in case, the input image has a channel dimension</span>
    <span class=k>return</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_and</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span> <span class=n>mask</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<h4 id="_3">考察</h4>
<p>エッジ検出する際は、先にROIを使わない方がよい。マスクされた境界部分がエッジとして強く出てしまうため。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='2'></p>
<h2 id="pythonopencv-inverse-perspective-mapping">[Python/OpenCV] Inverse Perspective Mapping</h2>
<p>Inverse Perspective Mapping(IPM)はBird's eye、TopView、鳥瞰図などと呼ばれる真上から見た画像に変換することが出来ます。<br>
<img alt="" src="document/result_frame_86_before_ipm.jpg" />
<img alt="" src="document/result_frame_86_after_ipm.jpg" />
<img alt="" src="document/result_frame_86_ipm.jpg" /><br>
<hr></p>
<h4 id="pythonopencv_1">[Python/OpenCV] 座標を探す</h4>
<p>IPMの座標は、道路の直線に沿うように座標を探します。<br>
ROIと同じ座標になりますが、変換をかけるため、ROIのmask用座標配列順とは異なる配列になります。<br>
<img alt="" src="document/result_frame_86_before_ipm.jpg" />
<img alt="" src="document/result_frame_86_after_ipm.jpg" />
<img alt="" src="document/result_frame_86_ipm.jpg" /><br>
ソースコード：<a href="to_inverse_perspective_mapping.py">./to_inverse_perspective_mapping.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4</pre></div></td><td class=code><div class=codehilite><pre><span></span>        <span class=c1># robocar camera demo_lane</span>
        <span class=n>ipm_vertices</span> <span class=o>=</span> <span class=n>calc_ipm_vertices</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span>
                                         <span class=n>top_width_rate</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span><span class=n>top_height_position</span><span class=o>=</span><span class=mf>0.15</span><span class=p>,</span>
                                         <span class=n>bottom_width_rate</span><span class=o>=</span><span class=mf>2.0</span><span class=p>,</span><span class=n>bottom_height_position</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>実際のコードではROIで処理を行ってからIPM処理を行っていますが、ROIの効果が限定的なため、ROIは無くてもいいかもしれません。
<hr></p>
<h4 id="pythonopencv_2">[Python/OpenCV] 処理</h4>
<p>ソース座標とディストネーション座標から変換行列を作成し、変換します。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>to_ipm</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span><span class=n>ipm_vertices</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    Inverse Perspective Mapping</span>
<span class=sd>    TopViewに画像を変換する</span>
<span class=sd>    args:</span>
<span class=sd>        cv_bgr: OpenCV BGR画像データ</span>
<span class=sd>        ipm_vertices: 視点変換座標</span>
<span class=sd>    return:</span>
<span class=sd>        cv_bgr_ipm: 変換後のOpenCV BGR画像データ</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>rows</span><span class=p>,</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>cv_bgr</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span>

    <span class=n>offset</span> <span class=o>=</span> <span class=n>cols</span><span class=o>*.</span><span class=mi>25</span>

    <span class=n>src</span> <span class=o>=</span> <span class=n>ipm_vertices</span>
    <span class=n>dst</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>([[</span><span class=n>offset</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>cols</span> <span class=o>-</span> <span class=n>offset</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>cols</span> <span class=o>-</span> <span class=n>offset</span><span class=p>,</span> <span class=n>rows</span><span class=p>],</span> <span class=p>[</span><span class=n>offset</span><span class=p>,</span> <span class=n>rows</span><span class=p>]])</span>

    <span class=c1># srcとdst座標に基づいて変換行列を作成する</span>
    <span class=n>matrix</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>getPerspectiveTransform</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>)</span>

    <span class=c1># 変換行列から画像をTopViewに変換する</span>
    <span class=n>cv_bgr_ipm</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>warpPerspective</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span> <span class=n>matrix</span><span class=p>,</span> <span class=p>(</span><span class=n>cols</span><span class=p>,</span> <span class=n>rows</span><span class=p>))</span>

    <span class=k>return</span> <span class=n>cv_bgr_ipm</span>
</pre></div></td></tr></table></p>
<hr>

<h4 id="pythonopencv_3">[Python/OpenCV] 逆変換</h4>
<p>IPMはソース座標とディストネーション座標を逆にすることで、元の座標系に戻すことが可能です。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>reverse_ipm</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span><span class=n>ipm_vertices</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    IPM逆変換を行う</span>
<span class=sd>    args:</span>
<span class=sd>        cv_bgr: OpenCV BGR画像データ</span>
<span class=sd>        ipm_vertices: 変換時に使ったIPM座標</span>
<span class=sd>    return:</span>
<span class=sd>        cv_bgr_ipm_reverse: OpenCV BGR画像データ</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>rows</span><span class=p>,</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>cv_bgr</span><span class=o>.</span><span class=n>shape</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span>

    <span class=n>offset</span> <span class=o>=</span> <span class=n>cols</span><span class=o>*.</span><span class=mi>25</span>

    <span class=n>dst</span> <span class=o>=</span> <span class=n>ipm_vertices</span>
    <span class=n>src</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>([[</span><span class=n>offset</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>cols</span> <span class=o>-</span> <span class=n>offset</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=p>[</span><span class=n>cols</span> <span class=o>-</span> <span class=n>offset</span><span class=p>,</span> <span class=n>rows</span><span class=p>],</span> <span class=p>[</span><span class=n>offset</span><span class=p>,</span> <span class=n>rows</span><span class=p>]])</span>

    <span class=n>matrix</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>getPerspectiveTransform</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>)</span>

    <span class=n>cv_bgr_ipm_reverse</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>warpPerspective</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span> <span class=n>matrix</span><span class=p>,</span> <span class=p>(</span><span class=n>cols</span><span class=p>,</span><span class=n>rows</span><span class=p>))</span>
    <span class=k>return</span> <span class=n>cv_bgr_ipm_reverse</span>
</pre></div></td></tr></table></p>
<p>IPM変換時に範囲外となった画像データは残っていませんので黒くなります。<br></p>
<hr>

<h4 id="_4">考察</h4>
<p>ROIは使わないこともありますが、IPMは必須となる処理です。<br>
この変換により、直線の割り出しが簡単になります。<br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='3'></p>
<h2 id="pythonopencv_4">[Python/OpenCV] 白色フィルタ</h2>
<p>画像から白線となる白色ピクセルを抜き出します。<br>
ここが最難関の部分で、白色フィルタの善し悪しでレーン検出の善し悪しが決まります。<br>
<img alt="" src="document/result_frame_276_white.jpg" /><br></p>
<hr>

<h4 id="pythonopencv_5">[Python/OpenCV] 処理</h4>
<p>フィルタ範囲が狭いと白線を十分に検出出来ません。そこでフィルタ範囲を広げると今度はカーペットの色まで拾ってしまうので、これも失敗に繋がります。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>to_white</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    白色だけを抽出する</span>
<span class=sd>    args:</span>
<span class=sd>        cv_bgr: OpenCV BGR画像データ</span>
<span class=sd>    return:</span>
<span class=sd>        cv_bgr_result: OpenCV BGR画像データ</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;to_white()&quot;</span><span class=p>)</span>
    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
    <span class=n>cv_hsv</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2HSV</span><span class=p>)</span>
    <span class=c1># 取得する色の範囲を指定する</span>
    <span class=n>lower1_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>120</span><span class=p>])</span>
    <span class=n>upper1_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>45</span><span class=p>,</span><span class=mi>40</span><span class=p>,</span><span class=mi>255</span><span class=p>])</span>
    <span class=n>lower2_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>50</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>200</span><span class=p>])</span>
    <span class=n>upper2_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>100</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>255</span><span class=p>])</span>
    <span class=n>lower3_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>45</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>225</span><span class=p>])</span>
    <span class=n>upper3_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>100</span><span class=p>,</span><span class=mi>40</span><span class=p>,</span><span class=mi>255</span><span class=p>])</span>
    <span class=n>lower4_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>50</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>180</span><span class=p>])</span>
    <span class=n>upper4_color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>75</span><span class=p>,</span><span class=mi>25</span><span class=p>,</span><span class=mi>200</span><span class=p>])</span>

    <span class=c1># 指定した色に基づいたマスク画像の生成</span>
    <span class=n>white1_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>inRange</span><span class=p>(</span><span class=n>cv_hsv</span><span class=p>,</span><span class=n>lower1_color</span><span class=p>,</span><span class=n>upper1_color</span><span class=p>)</span>
    <span class=n>white2_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>inRange</span><span class=p>(</span><span class=n>cv_hsv</span><span class=p>,</span><span class=n>lower2_color</span><span class=p>,</span><span class=n>upper2_color</span><span class=p>)</span>
    <span class=n>white3_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>inRange</span><span class=p>(</span><span class=n>cv_hsv</span><span class=p>,</span><span class=n>lower3_color</span><span class=p>,</span><span class=n>upper3_color</span><span class=p>)</span>
    <span class=n>white4_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>inRange</span><span class=p>(</span><span class=n>cv_hsv</span><span class=p>,</span><span class=n>lower4_color</span><span class=p>,</span><span class=n>upper4_color</span><span class=p>)</span>
    <span class=n>img_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_or</span><span class=p>(</span><span class=n>white1_mask</span><span class=p>,</span> <span class=n>white2_mask</span><span class=p>)</span>
    <span class=n>img_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_or</span><span class=p>(</span><span class=n>img_mask</span><span class=p>,</span> <span class=n>white3_mask</span><span class=p>)</span>
    <span class=n>img_mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_or</span><span class=p>(</span><span class=n>img_mask</span><span class=p>,</span> <span class=n>white4_mask</span><span class=p>)</span>
    <span class=c1># フレーム画像とマスク画像の共通の領域を抽出する</span>
    <span class=n>cv_bgr_result</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_and</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,</span><span class=n>cv_bgr</span><span class=p>,</span><span class=n>mask</span><span class=o>=</span><span class=n>img_mask</span><span class=p>)</span>
    <span class=n>t1</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
    <span class=n>dt_cv</span> <span class=o>=</span> <span class=n>t1</span><span class=o>-</span><span class=n>t0</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;Conversion took {:.5} seconds&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>dt_cv</span><span class=p>))</span>

    <span class=k>return</span> <span class=n>cv_bgr_result</span>
</pre></div></td></tr></table></p>
<hr>

<h4 id="_5">考察</h4>
<p>出来ればここにCycle GAN<a href="https://github.com/XHUJOY/CycleGAN-tensorflow">(https://github.com/XHUJOY/CycleGAN-tensorflow)</a>のようなDeepLearningを用いて白線を綺麗に補完したものを用いたいところですが、今回は通常の白色フィルタを使って白色ピクセルを抜き出します。</p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='4'></p>
<h2 id="2">2値化</h2>
<p>白色フィルタで白色っぽいピクセルだけを取り出したので、それを2値化します。<br>
<img alt="" src="document/result_frame_276_bin.jpg" /><br></p>
<h4 id="_6">処理</h4>
<p>2値化する際はガウスぼかしをセットで実施して境界線の弱い部分を消しておきます。<br>
カーペット部分を少しでも消したいため、グレースケール化した際に薄く残っている部分を削除しています。<br></p>
<p>ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>to_bin</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    画像を2値化する</span>
<span class=sd>    args:</span>
<span class=sd>        cv_bgr: OpenCV BGR画像データ</span>
<span class=sd>    return:</span>
<span class=sd>        cv_bin: OpenCV 2値化したグレースケール画像データ</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;to_bin()&quot;</span><span class=p>)</span>
    <span class=n>t0</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
    <span class=c1># ガウスぼかしで境界線の弱い部分を消す</span>
    <span class=n>cv_gauss</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>GaussianBlur</span><span class=p>(</span><span class=n>cv_bgr</span><span class=p>,(</span><span class=mi>5</span><span class=p>,</span><span class=mi>5</span><span class=p>),</span><span class=mi>0</span><span class=p>)</span> <span class=c1># サイズは奇数</span>
    <span class=n>cv_gray</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>cv_gauss</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_BGR2GRAY</span><span class=p>)</span>
    <span class=c1>#plt.title(&#39;gray&#39;)</span>
    <span class=c1>#plt.imshow(cv_gray)</span>
    <span class=c1>#plt.show()</span>

    <span class=c1># 色の薄い部分を削除する</span>
    <span class=n>ret</span><span class=p>,</span> <span class=n>mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>threshold</span><span class=p>(</span><span class=n>cv_gray</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>255</span><span class=p>,</span> <span class=n>cv2</span><span class=o>.</span><span class=n>THRESH_BINARY</span><span class=p>)</span>
    <span class=n>mask</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_and</span><span class=p>(</span><span class=n>cv_gray</span><span class=p>,</span><span class=n>cv_gray</span><span class=p>,</span><span class=n>mask</span><span class=o>=</span><span class=n>mask</span><span class=p>)</span>
    <span class=n>cv_gray</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>bitwise_and</span><span class=p>(</span><span class=n>cv_gray</span><span class=p>,</span><span class=n>cv_gray</span><span class=p>,</span><span class=n>mask</span><span class=o>=</span><span class=n>mask</span><span class=p>)</span>
    <span class=c1>#plt.title(&#39;gray&#39;)</span>
    <span class=c1>#plt.imshow(cv_gray)</span>
    <span class=c1>#plt.show()</span>

    <span class=c1># 入力画像，閾値，maxVal，閾値処理手法</span>
    <span class=n>ret</span><span class=p>,</span><span class=n>cv_bin</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>threshold</span><span class=p>(</span><span class=n>cv_gray</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>,</span><span class=n>cv2</span><span class=o>.</span><span class=n>THRESH_BINARY</span><span class=o>|</span><span class=n>cv2</span><span class=o>.</span><span class=n>THRESH_OTSU</span><span class=p>);</span>

    <span class=n>t1</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
    <span class=n>dt_cv</span> <span class=o>=</span> <span class=n>t1</span><span class=o>-</span><span class=n>t0</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;Conversion took {:.5} seconds&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>dt_cv</span><span class=p>))</span>
    <span class=k>return</span> <span class=n>cv_bin</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a>
<hr></p>
<p><a name='5'></p>
<h2 id="pythonopencv-histogram">[Python/OpenCV] histogram</h2>
<p>sliding windowを始めるにあたって、最初のwindowの開始x座標を決める必要があります。<br>
そこで、2値化した画像下半分の各x座標上にあるピクセル数をカウントしたものをhistogramとします。<br>
sliding windowはhistogramの左右それぞれの最大値となるx座標から開始することにします。<br></p>
<p>ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=c1># 画面下半分のピクセル数をカウントする</span>
    <span class=n>histogram</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>cv_bin</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>rows</span><span class=o>/</span><span class=mi>2</span><span class=p>):,:],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p><img alt="" src="document/result_frame_276_histogram.jpg" /><br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='6'></p>
<h2 id="pythonopencv-sliding-windows">[Python/OpenCV] Sliding Windows</h2>
<p>sliding windowsは左右のライン候補となるピクセル座標を求めるために、適当なサイズの枠をY軸方向にスライドしながら探していきます。<br>
開始位置のY座標は画像下から、X座標はhistogramの左右それぞれの最大値となるx座標から開始することにします。<br>
ウインドウの幅や高さは、白線の幅、カーブへの追従具合、ノイズの拾いやすさとのバランスで決めることになります。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>sliding_windows</span><span class=p>(</span><span class=n>cv_bin</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    sliding windowを行い、左右レーンを構成するピクセル座標を求める</span>
<span class=sd>    args:</span>
<span class=sd>        cv_bin: 2値化したレーン画像のOpenCV grayscale画像データ</span>
<span class=sd>    returns:</span>
<span class=sd>        cv_rgb_sliding_windows: sliding window処理のOpenCV RGB画像データ</span>
<span class=sd>        histogram: 入力画像の下半分の列毎のピクセル総数の配列(1,col)</span>
<span class=sd>        left_x: 左レーンを構成するピクセルのx座標群</span>
<span class=sd>        left_y: 左レーンを構成するピクセルのy座標群</span>
<span class=sd>        right_x: 右レーンを構成するピクセルのx座標群</span>
<span class=sd>        right_y: 右レーンを構成するピクセルのy座標群</span>
<span class=sd>    &#39;&#39;&#39;</span>
</pre></div></td></tr></table></p>
<p><img alt="" src="document/result_frame_276_sliding_windows.jpg" /><br></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='7'></p>
<h2 id="pythonopencv_6">[Python/OpenCV] ライン検出</h2>
<p>sliding windowsによって左右白線のピクセル座標を得たら、それぞれにpolynormal fitを適用して二次多項式の定数を求めます。<br>
<img alt="" src="document/result_frame_276_bin_road.jpg" /><br></p>
<p>ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>polynormal_fit</span><span class=p>(</span><span class=n>pts_y</span><span class=p>,</span><span class=n>pts_x</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    曲線を構成する点から二次多項式を求める</span>
<span class=sd>    (y軸の値は均等に取るのでxを求める式となる)</span>
<span class=sd>    args:</span>
<span class=sd>        pts_x: x座標配列</span>
<span class=sd>        pts_y: y座標配列</span>
<span class=sd>    returns:</span>
<span class=sd>        polyfit_const: 二次曲線x=ay**2+by+cの[a,b,c]の値</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>polyfit_const</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>polyfit</span><span class=p>(</span><span class=n>pts_y</span><span class=p>,</span> <span class=n>pts_x</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>polyfit_const</span>
</pre></div></td></tr></table></p>
<p>左右二次多項式の定数から中央線の二次多項式の定数を求めます。<br>
ソースコード：<a href="opencv_lane_detection.py">./opencv_lane_detection.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>                <span class=c1># 左右センターの二次多項式と座標を求める</span>
                <span class=n>left_polyfit_const</span><span class=p>,</span> <span class=n>right_polyfit_const</span><span class=p>,</span> <span class=n>center_polyfit_const</span><span class=p>,</span> \
                    <span class=n>pts_left</span><span class=p>,</span> <span class=n>pts_right</span><span class=p>,</span> <span class=n>pts_center</span> <span class=o>=</span> <span class=n>calc_lr_curve_lane</span><span class=p>(</span><span class=n>left_x</span><span class=p>,</span><span class=n>left_y</span><span class=p>,</span><span class=n>right_x</span><span class=p>,</span><span class=n>right_y</span><span class=p>,</span><span class=n>plot_y</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>calc_lr_curve_lane</span><span class=p>(</span><span class=n>left_x</span><span class=p>,</span><span class=n>left_y</span><span class=p>,</span><span class=n>right_x</span><span class=p>,</span><span class=n>right_y</span><span class=p>,</span><span class=n>plot_y</span><span class=p>):</span>
<span class=o>...</span>
    <span class=c1># 左右の二次多項式を求める</span>
    <span class=n>left_polyfit_const</span> <span class=o>=</span> <span class=n>polynormal_fit</span><span class=p>(</span><span class=n>left_y</span><span class=p>,</span><span class=n>left_x</span><span class=p>)</span>
    <span class=n>right_polyfit_const</span> <span class=o>=</span> <span class=n>polynormal_fit</span><span class=p>(</span><span class=n>right_y</span><span class=p>,</span><span class=n>right_x</span><span class=p>)</span>
    <span class=c1># センターの二次多項式を求める</span>
    <span class=n>center_polyfit_const</span> <span class=o>=</span> <span class=p>[(</span><span class=n>left_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=n>right_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span><span class=o>/</span><span class=mi>2</span><span class=p>,(</span><span class=n>left_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=n>right_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span><span class=o>/</span><span class=mi>2</span><span class=p>,(</span><span class=n>left_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>+</span><span class=n>right_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span><span class=o>/</span><span class=mi>2</span><span class=p>]</span>
</pre></div></td></tr></table></p>
<p>Y軸に等間隔な座標を生成し、左右中央の曲線上の座標を求めます。<br>
ソースコード：<a href="opencv_lane_detection.py">./opencv_lane_detection.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2</pre></div></td><td class=code><div class=codehilite><pre><span></span>            <span class=c1># 等間隔なy座標を生成する</span>
            <span class=n>plot_y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>rows</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>rows</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p>ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>calc_lr_curve_lane</span><span class=p>(</span><span class=n>left_x</span><span class=p>,</span><span class=n>left_y</span><span class=p>,</span><span class=n>right_x</span><span class=p>,</span><span class=n>right_y</span><span class=p>,</span><span class=n>plot_y</span><span class=p>):</span>
<span class=o>...</span>
    <span class=c1># y軸に対する左右の二次多項式上のx座標を求める</span>
    <span class=n>left_plot_x</span> <span class=o>=</span> <span class=n>left_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>plot_y</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>left_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>plot_y</span> <span class=o>+</span> <span class=n>left_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
    <span class=n>right_plot_x</span> <span class=o>=</span> <span class=n>right_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>plot_y</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>right_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>plot_y</span> <span class=o>+</span> <span class=n>right_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
    <span class=c1># y軸に対するセンターの二次多項式上のx座標を求める</span>
    <span class=n>center_plot_x</span> <span class=o>=</span> <span class=n>center_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>plot_y</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>center_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>plot_y</span> <span class=o>+</span> <span class=n>center_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>

    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    x,y座標を[x,y]配列に変換する</span>
<span class=sd>    左右間の領域描画用に、右側座標は逆順にする</span>
<span class=sd>    pts_centerは中間線上の座標</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>pts_left</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>vstack</span><span class=p>([</span><span class=n>left_plot_x</span><span class=p>,</span> <span class=n>plot_y</span><span class=p>]))]))</span>
    <span class=n>pts_right</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>flipud</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>vstack</span><span class=p>([</span><span class=n>right_plot_x</span><span class=p>,</span> <span class=n>plot_y</span><span class=p>])))]))</span>
    <span class=n>pts_center</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>vstack</span><span class=p>([</span><span class=n>center_plot_x</span><span class=p>,</span> <span class=n>plot_y</span><span class=p>]))]))</span>

    <span class=k>return</span> <span class=n>left_polyfit_const</span><span class=p>,</span> <span class=n>right_polyfit_const</span><span class=p>,</span> <span class=n>center_polyfit_const</span><span class=p>,</span> <span class=n>pts_left</span><span class=p>,</span> <span class=n>pts_right</span><span class=p>,</span> <span class=n>pts_center</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='8'></p>
<h2 id="pythonopencv_7">[Python/OpenCV] 弧の角度と傾き角</h2>
<p>画像内の道路は手前が直線、奥がカーブのようなケースがあるため、画面を上下2分割して角度を考えます。<br>
弧の角度はカーブの急さを表し、奥のカーブが急な時、減速する判断に用いることが出来ます。<br>
傾き角度は垂直方向と中央線の傾き角度を表し、手前のtilt1が中央線との現在の角度差になります。<br>
手前の傾き角度となるtilt1の値と、奥のカーブ角度となるangle2の値が重要になります。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>calc_curve</span><span class=p>(</span><span class=n>curve_y0</span><span class=p>,</span><span class=n>curve_y1</span><span class=p>,</span><span class=n>curve_polyfit_const</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    曲線を計算する</span>
<span class=sd>    args:</span>
<span class=sd>        curve_y0: 曲線上y座標</span>
<span class=sd>        curve_y1: 曲線下y座標</span>
<span class=sd>        curve_ployfit_const: 曲線の定数</span>
<span class=sd>    returns:</span>
<span class=sd>        x: 円の中心x座標</span>
<span class=sd>        y: 円の中心y座標</span>
<span class=sd>        r: 円の半径r (曲率半径r)</span>
<span class=sd>        rotate_deg: 弧の回転角度</span>
<span class=sd>        angle_deg: 弧の描画角度</span>
<span class=sd>        curve_tilt_deg: y軸との傾き角度</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=c1># 中間点における曲率半径Rを求める</span>
    <span class=n>curve_y</span> <span class=o>=</span> <span class=n>curve_y1</span><span class=o>-</span><span class=n>curve_y0</span>
    <span class=n>curve_r</span> <span class=o>=</span> <span class=n>calc_curvature_radius</span><span class=p>(</span><span class=n>curve_polyfit_const</span><span class=p>,</span><span class=n>curve_y</span><span class=p>)</span>

    <span class=c1># x座標を求める</span>
    <span class=n>curve_x0</span> <span class=o>=</span> <span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>curve_y0</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>curve_y0</span> <span class=o>+</span> <span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
    <span class=n>curve_x1</span> <span class=o>=</span> <span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>curve_y1</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>curve_y1</span> <span class=o>+</span> <span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>

    <span class=c1># 2点と半径と曲線の定数から円の中心座標を求める</span>
    <span class=n>py</span> <span class=o>=</span> <span class=n>curve_y1</span>
    <span class=n>px</span> <span class=o>=</span> <span class=n>curve_x1</span>
    <span class=n>qy</span> <span class=o>=</span> <span class=n>curve_y0</span>
    <span class=n>qx</span> <span class=o>=</span> <span class=n>curve_x0</span>
    <span class=n>r</span> <span class=o>=</span> <span class=n>curve_r</span>
    <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=o>=</span> <span class=n>calc_circle_center_point</span><span class=p>(</span><span class=n>px</span><span class=p>,</span><span class=n>py</span><span class=p>,</span><span class=n>qx</span><span class=p>,</span><span class=n>qy</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>

    <span class=c1># 弧の描画角度を求める</span>
    <span class=n>rotate_deg</span><span class=p>,</span> <span class=n>angle_deg</span> <span class=o>=</span> <span class=n>calc_ellipse_angle</span><span class=p>(</span><span class=n>py</span><span class=p>,</span><span class=n>px</span><span class=p>,</span><span class=n>qy</span><span class=p>,</span><span class=n>qx</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>curve_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;py={},px={},qy={},qx={},x={},y={},r={}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>py</span><span class=p>,</span><span class=n>px</span><span class=p>,</span><span class=n>qy</span><span class=p>,</span><span class=n>qx</span><span class=p>,</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>r</span><span class=p>))</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;rotate_deg={} angle_deg={}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>rotate_deg</span><span class=p>,</span><span class=n>angle_deg</span><span class=p>))</span>

    <span class=c1># 垂直方向との傾き角を求める</span>
    <span class=c1># プラスなら左カーブ、マイナスなら右カーブ</span>
    <span class=n>curve_tilt_rad</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>atan</span><span class=p>((</span><span class=n>px</span><span class=o>-</span><span class=n>qx</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>py</span><span class=o>-</span><span class=n>qy</span><span class=p>))</span>
    <span class=n>curve_tilt_deg</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>degrees</span><span class=p>(</span><span class=n>curve_tilt_rad</span><span class=p>)</span>
    <span class=k>print</span><span class=p>(</span><span class=s2>&quot;curve_tilt_deg={}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>curve_tilt_deg</span><span class=p>))</span>

    <span class=k>return</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>rotate_deg</span><span class=p>,</span><span class=n>angle_deg</span><span class=p>,</span><span class=n>curve_tilt_deg</span>
</pre></div></td></tr></table></p>
<p><img alt="" src="document/result_frame_276_ellipse.jpg" /><br>
<img alt="" src="document/result_frame_276_tilt.jpg" /><br></p>
<h4 id="_7">円の中心座標の求め方</h4>
<p>ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=k>def</span> <span class=nf>calc_circle_center_point</span><span class=p>(</span><span class=n>px</span><span class=p>,</span><span class=n>py</span><span class=p>,</span><span class=n>qx</span><span class=p>,</span><span class=n>qy</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>const</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    2点と半径rから円の中心座標を求める</span>
<span class=sd>    args:</span>
<span class=sd>        py: 円上の点Pのy座標</span>
<span class=sd>        px: 円上の点Pのx座標</span>
<span class=sd>        qy: 円上の点Qのy座標</span>
<span class=sd>        qx: 円上の点Qのx座標</span>
<span class=sd>        r: 円の半径r</span>
<span class=sd>        const: 候補2点の識別子</span>
<span class=sd>    return:</span>
<span class=sd>        x: 円の中心点x座標</span>
<span class=sd>        y: 円の中心点y座標</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=k>if</span> <span class=n>const</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>x</span><span class=o>=</span><span class=p>((</span><span class=n>py</span> <span class=o>-</span> <span class=n>qy</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>4</span><span class=o>*</span><span class=n>r</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span><span class=o>*</span><span class=p>(</span><span class=n>px</span> <span class=o>-</span> <span class=n>qx</span><span class=p>)</span> <span class=o>-</span> <span class=p>(</span><span class=n>py</span> <span class=o>+</span> <span class=n>qy</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span> <span class=o>+</span> <span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span><span class=o>/</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=p>(</span><span class=n>px</span> <span class=o>-</span> <span class=n>qx</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span>
        <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>4</span><span class=o>*</span><span class=n>r</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span><span class=o>*</span><span class=p>(</span><span class=o>-</span><span class=n>px</span> <span class=o>+</span> <span class=n>qx</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span> <span class=o>+</span> <span class=p>(</span><span class=n>py</span> <span class=o>+</span> <span class=n>qy</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>x</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=n>py</span> <span class=o>-</span> <span class=n>qy</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>4</span><span class=o>*</span><span class=n>r</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span><span class=o>*</span><span class=p>(</span><span class=n>px</span> <span class=o>-</span> <span class=n>qx</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>py</span> <span class=o>+</span> <span class=n>qy</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span> <span class=o>+</span> <span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span><span class=o>/</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=p>(</span><span class=n>px</span> <span class=o>-</span> <span class=n>qx</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span>
        <span class=n>y</span><span class=o>=</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>4</span><span class=o>*</span><span class=n>r</span><span class=o>**</span><span class=mi>2</span><span class=p>))</span><span class=o>*</span><span class=p>(</span><span class=n>px</span> <span class=o>-</span> <span class=n>qx</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span> <span class=o>+</span> <span class=p>(</span><span class=n>py</span> <span class=o>+</span> <span class=n>qy</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>px</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>px</span><span class=o>*</span><span class=n>qx</span> <span class=o>+</span> <span class=n>py</span><span class=o>**</span><span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>py</span><span class=o>*</span><span class=n>qy</span> <span class=o>+</span> <span class=n>qx</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>qy</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span>
</pre></div></td></tr></table></p>
<p>この呪文は何でしょうか？<br>
答えは次の連立方程式をx,yについて解いた物になります。<br></p>
<blockquote>
<p>(x-px)<strong>2+(y-py)</strong>2=r<strong>2, (x-qx)</strong>2+(y-qy)<strong>2=r</strong>2</p>
</blockquote>
<p>この式は人力で解くのは大変なので、sympyを使って解を取得します。<br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=kn>import</span> <span class=nn>sympy</span>
<span class=kn>import</span> <span class=nn>time</span>
<span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<span class=n>x</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>)</span> <span class=c1># 変数xを出力時の文字&#39;x&#39;として用意する</span>
<span class=n>y</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;y&#39;</span><span class=p>)</span> <span class=c1># 変数yを出力時の文字&#39;y&#39;として用意する</span>
<span class=n>r</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=c1># 変数rを出力時の文字&#39;r&#39;として用意する</span>
<span class=n>px</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;px&#39;</span><span class=p>)</span>
<span class=n>py</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;py&#39;</span><span class=p>)</span>
<span class=n>qx</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;qx&#39;</span><span class=p>)</span>
<span class=n>qy</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Symbol</span><span class=p>(</span><span class=s1>&#39;qy&#39;</span><span class=p>)</span>

<span class=sd>&quot;&quot;&quot;</span>
<span class=sd>方程式: solve</span>
<span class=sd>連立方程式 (x-px)**2+(y-py)**2=r**2, (x-qx)**2+(y-qy)**2=r**2 の解を求める</span>
<span class=sd>&quot;&quot;&quot;</span>
<span class=n>b</span><span class=o>=</span> <span class=n>sympy</span><span class=o>.</span><span class=n>solve</span> <span class=p>([(</span><span class=n>x</span><span class=o>-</span><span class=n>px</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=o>+</span><span class=p>(</span><span class=n>y</span><span class=o>-</span><span class=n>py</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=o>-</span><span class=n>r</span><span class=o>**</span><span class=mi>2</span><span class=p>,</span> <span class=p>(</span><span class=n>x</span><span class=o>-</span><span class=n>qx</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=o>+</span><span class=p>(</span><span class=n>y</span><span class=o>-</span><span class=n>qy</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=o>-</span><span class=n>r</span><span class=o>**</span><span class=mi>2</span><span class=p>],[</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>])</span>  <span class=c1># 連立方程式を解く</span>
<span class=k>print</span><span class=p>(</span><span class=s2>&quot;time:{}&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>))</span>
<span class=k>print</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<blockquote>
<p><code>time:27.699626922607422</code><br>
<code>[(((py - qy)*(sqrt(-(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2 - 4*r**2))*(px - qx) - (py + qy)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)) + (px**2 + py**2 - qx**2 - qy**2)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2))/(2*(px - qx)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)), (sqrt(-(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2 - 4*r**2))*(-px + qx)/2 + (py + qy)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)/2)/(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)), ((-(py - qy)*(sqrt(-(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2 - 4*r**2))*(px - qx) + (py + qy)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)) + (px**2 + py**2 - qx**2 - qy**2)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2))/(2*(px - qx)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)), (sqrt(-(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2 - 4*r**2))*(px - qx)/2 + (py + qy)*(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2)/2)/(px**2 - 2*px*qx + py**2 - 2*py*qy + qx**2 + qy**2))]</code></p>
</blockquote>
<p>x,yの解は2つあるので、最初の2つの,までが一つ目の(x,y)の解、次に二つ目の(x,y)の解が続きます。<br>
この式のsqrtをnp.sqrtに置換してx,yを求める式として利用しています。</p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='9'></p>
<h2 id="pythonopencv_8">[Python/OpenCV] ピクセル座標と実座標</h2>
<p>描画時はピクセル座標になりますが、数値として出す際は実際の空間での座標系で計算する必要があります。<br>
実座標ではx方向への1ピクセル分とy方向への1ピクセル分は異なる長さになります。そのため、ピクセル座標を実座標に変換して計算することになります。<br>
IPM変換後の画像(黒い部分も含めて)の縦と横のメートルを設定します。<br>
<img alt="" src="document/result_frame_86_ipm.jpg" /><br>
ソースコード：<a href="opencv_lane_detection.py">./opencv_lane_detection.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=c1># IPM変換後の画像におけるx,yメートル(黒い部分も含む)</span>
    <span class=n>X_METER</span><span class=o>=</span><span class=mi>3</span>
    <span class=n>Y_METER</span><span class=o>=</span><span class=mf>1.5</span>
<span class=o>...</span>
                <span class=sd>&#39;&#39;&#39;&#39;</span>
<span class=sd>                実測値 メートル座標系における計算</span>
<span class=sd>                &#39;&#39;&#39;</span>
                <span class=c1># ピクセルをメートルに変換</span>
                <span class=n>ym_per_pix</span> <span class=o>=</span> <span class=mf>1.0</span><span class=o>*</span><span class=n>Y_METER</span><span class=o>/</span><span class=n>rows</span>
                <span class=n>xm_per_pix</span> <span class=o>=</span> <span class=mf>1.0</span><span class=o>*</span><span class=n>X_METER</span><span class=o>/</span><span class=n>cols</span>
                <span class=c1># 等間隔なy座標を生成する</span>
                <span class=n>plot_ym</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>rows</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>rows</span><span class=p>)</span><span class=o>*</span><span class=n>ym_per_pix</span>
                <span class=c1># 左右センターの二次多項式と座標を求める</span>
                <span class=n>left_polyfit_const</span><span class=p>,</span> <span class=n>right_polyfit_const</span><span class=p>,</span> <span class=n>center_polyfit_const</span><span class=p>,</span> \
                    <span class=n>_pts_left</span><span class=p>,</span> <span class=n>_pts_right</span><span class=p>,</span> <span class=n>_pts_center</span> <span class=o>=</span> <span class=n>calc_lr_curve_lane</span><span class=p>(</span><span class=n>left_x</span><span class=o>*</span><span class=n>xm_per_pix</span><span class=p>,</span><span class=n>left_y</span><span class=o>*</span><span class=n>ym_per_pix</span><span class=p>,</span><span class=n>right_x</span><span class=o>*</span><span class=n>xm_per_pix</span><span class=p>,</span><span class=n>right_y</span><span class=o>*</span><span class=n>ym_per_pix</span><span class=p>,</span><span class=n>plot_ym</span><span class=p>)</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='10'></p>
<h2 id="pythonopencv_9">[Python/OpenCV] 中央線までの距離</h2>
<p>中央線の画像下と、画像中央位置から、中央線までの距離を求めます。<br>
傾き角度となるtilt1の値をそのままハンドル値に設定すると、道路の真ん中ではない所を道路と並行に走ることになるため、道路の真ん中に寄せるためにこの値もハンドル角に考慮することになります。<br></p>
<p>ソースコード：<a href="opencv_lane_detection.py">./opencv_lane_detection.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5</pre></div></td><td class=code><div class=codehilite><pre><span></span>                <span class=c1># 中央線までの距離を計算する</span>
                <span class=c1># 最も下の位置で計算する</span>
                <span class=n>bottom_y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>plot_ym</span><span class=p>)</span>
                <span class=n>bottom_x</span> <span class=o>=</span> <span class=n>center_polyfit_const</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>bottom_y</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>center_polyfit_const</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>bottom_y</span> <span class=o>+</span> <span class=n>center_polyfit_const</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
                <span class=n>meters_from_center</span> <span class=o>=</span> <span class=n>bottom_x</span> <span class=o>-</span> <span class=p>(</span><span class=n>cols</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span><span class=o>*</span><span class=n>xm_per_pix</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='11'></p>
<h2 id="pythonopencv_10">[Python/OpenCV] 描画</h2>
<p>処理が多いので、確認のための描画も多くなります。<br>
その中でもcv2.ellipse()を用いた弧の描画は角度が0.5度以下を描画出来なかったり、小数点以下の精度が悪いため、直線に近い時に描画がズレてしまう問題があります。<br>
下のコード例では、最初に赤色の弧を塗りつぶしていますが、その上に青色の弧をより小さい角度で塗りつぶしています。しかし、赤色と青色の描画範囲が全く同じになってしまいます。<br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class=code><div class=codehilite><pre><span></span><span class=c1># coding: utf-8</span>
<span class=o>%</span><span class=n>matplotlib</span> <span class=n>inline</span>
<span class=kn>import</span> <span class=nn>cv2</span>
<span class=kn>from</span> <span class=nn>matplotlib</span> <span class=kn>import</span> <span class=n>pyplot</span> <span class=k>as</span> <span class=n>plt</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=kn>as</span> <span class=nn>np</span>
<span class=k>def</span> <span class=nf>new_rgb</span><span class=p>(</span><span class=n>height</span><span class=p>,</span> <span class=n>width</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    新しいRGB画像を作成する</span>
<span class=sd>    args:</span>
<span class=sd>        height: 画像の高さ</span>
<span class=sd>        width: 画像の幅</span>
<span class=sd>    return:</span>
<span class=sd>        blank_image: 新しい画像データ</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>blank_image</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>height</span><span class=p>,</span><span class=n>width</span><span class=p>,</span><span class=mi>3</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>blank_image</span>

<span class=n>cols</span><span class=o>=</span><span class=mi>160</span>
<span class=n>rows</span><span class=o>=</span><span class=mi>120</span>

<span class=n>cv_rgb_ellipse</span> <span class=o>=</span> <span class=n>new_rgb</span><span class=p>(</span><span class=n>rows</span><span class=p>,</span><span class=n>cols</span><span class=p>)</span>

<span class=n>x</span><span class=o>=-</span><span class=mf>5412.0045467821865</span>
<span class=n>y</span><span class=o>=-</span><span class=mf>81.22929559489425</span>
<span class=n>r</span><span class=o>=</span><span class=mf>5496.265423776478</span>
<span class=n>rotate</span><span class=o>=</span><span class=mf>2.0877508233621227</span>
<span class=n>angle</span><span class=o>=-</span><span class=mf>0.820558947183531</span>

<span class=n>x</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
<span class=n>y</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>y</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>

<span class=n>cv2</span><span class=o>.</span><span class=n>ellipse</span><span class=p>(</span><span class=n>cv_rgb_ellipse</span><span class=p>,(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>),(</span><span class=n>r</span><span class=p>,</span><span class=n>r</span><span class=p>),</span><span class=n>rotate</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>angle</span><span class=p>,(</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>),</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
<span class=n>angle</span><span class=o>=-</span><span class=mf>0.620558947183531</span>
<span class=n>cv2</span><span class=o>.</span><span class=n>ellipse</span><span class=p>(</span><span class=n>cv_rgb_ellipse</span><span class=p>,(</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>),(</span><span class=n>r</span><span class=p>,</span><span class=n>r</span><span class=p>),</span><span class=n>rotate</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>angle</span><span class=p>,(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>255</span><span class=p>),</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>

<span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&quot;ellipse&quot;</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>cv_rgb_ellipse</span><span class=p>)</span>
<span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</pre></div></td></tr></table></p>
<p><img alt="" src="document/cv2_ellipse.png" /><br>
そこで弧の描画はfillPolyで行うようにしています。<br>
ソースコード：<a href="lib/functions.py">./lib/functions.py</a><br></p>
<p> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span>    <span class=n>pts_ellipse</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>pts_center</span><span class=p>[:,</span><span class=nb>int</span><span class=p>(</span><span class=n>pts_center</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>/</span><span class=mi>2</span><span class=p>):,:])</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
    <span class=n>pts_ellipse</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>((</span><span class=n>pts_ellipse</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[[</span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>]]])</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)),</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
    <span class=n>cv2</span><span class=o>.</span><span class=n>fillPoly</span><span class=p>(</span><span class=n>cv_rgb_ellipse</span><span class=p>,</span> <span class=p>[</span><span class=n>pts_ellipse</span><span class=p>],</span> <span class=p>(</span><span class=mi>255</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>))</span>
</pre></div></td></tr></table></p>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
<hr>

<p><a name='12'></p>
<h2 id="_8">[ディレクトリとファイルについて]</h2>
<ul>
<li>ディレクトリについて<br></li>
<li>documment/ ドキュメント関連<br></li>
<li>demo_lane/ デモ用ディレクトリ<br></li>
<li>lib/ 関数ライブラリ<br></li>
<li>test_images/ ROI,IPM,白色フィルタの確認用ディレクトリ<br></li>
<li>ファイルについて<br></li>
<li>README.md このファイル<br></li>
<li>opencv_lane_detection.py レーン検出コード<br></li>
<li>to_region_of_interest.py ROI座標確認コード<br></li>
<li>to_inverse_perspective_mapping.py IPM座標確認コード<br></li>
<li>to_white.py 白色フィルタ確認コード<br></li>
</ul>
<p><a href="#top">&lt;ページTOP&gt;</a>　<a href="#0">&lt;目次&gt;</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../10.level3_demo_streaming/" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前
                </span>
                Index
              </span>
            </div>
          </a>
        
        
          <a href="../12.level5_demo_streaming/" title="Index" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  次
                </span>
                Index
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>